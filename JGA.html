<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jannis Questlog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=IM+Fell+Double+Pica&display=swap" rel="stylesheet">
    
    <script type="module">
        // Deine Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyChyA0KQQMG0M4SnaHIdxwguJH8dYYDO-w",
            authDomain: "wowquestlogprojekt.firebaseapp.com",
            projectId: "wowquestlogprojekt",
            storageBucket: "wowquestlogprojekt.appspot.com",
            messagingSenderId: "689308532820",
            appId: "1:689308532820:web:0523701ea7c790a8c6adc1"
        };

        // Firebase Module importieren
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Globale Variablen
        let questsData = {};
        let currentSelectedQuestId = null;
        let adminMode = false;
        let db;

        // UI Elemente
        let questListContent, questDetailContent, questCounter, trackQuestBtn;

        // Hauptfunktion
        async function main() {
            questListContent = document.getElementById('quest-list-content');
            questDetailContent = document.getElementById('quest-detail-content');
            questCounter = document.getElementById('quest-counter');
            trackQuestBtn = document.getElementById('track-quest-btn');

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                console.log("Firebase angebunden.");
                setupFirestoreListener();
                setupEventListeners();
            } catch (error) {
                console.error("Firebase Fehler: ", error);
                questListContent.innerHTML = `<div class="quest-category" style="color: #c00;">Verbindung zur Datenbank fehlgeschlagen.</div>`;
            }
        }

        function setupFirestoreListener() {
            onSnapshot(collection(db, "quests"), (snapshot) => {
                questListContent.innerHTML = ''; // Liste leeren
                const docs = [];
                snapshot.forEach((doc) => docs.push({ id: doc.id, ...doc.data() }));
                
                docs.sort((a, b) => (a.order || 0) - (b.order || 0));

                questsData = {};
                let nonCategoryQuestsCount = 0;
                docs.forEach(quest => {
                    questsData[quest.id] = quest;

                    if (quest.isCategory) {
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'quest-category';
                        categoryItem.innerHTML = `<div class="quest-icon icon-collapse"></div><span>${quest.title}</span>`;
                        questListContent.appendChild(categoryItem);
                    } else {
                        nonCategoryQuestsCount++;
                        const questItem = document.createElement('div');
                        questItem.className = 'quest-item';
                        questItem.dataset.questId = quest.id;
                        questItem.innerHTML = `
                            <span class="quest-title">${quest.title}</span>
                            <span class="quest-status">
                                (${quest.xp || 'JGA'})
                                ${quest.status === 'completed' ? '<div class="quest-icon icon-checkmark"></div>' : ''}
                            </span>
                        `;
                        questListContent.appendChild(questItem);
                    }
                });
                
                if (questCounter) {
                    questCounter.innerText = `Quests: ${nonCategoryQuestsCount}/25`;
                }
                
                if (!currentSelectedQuestId && docs.length > 0) {
                    showQuestDetails(docs.find(q => !q.isCategory)?.id);
                } else {
                    showQuestDetails(currentSelectedQuestId);
                }
            });
        }
        
        function showQuestDetails(questId) {
             if (!questId || !questsData[questId] || questsData[questId].isCategory) return;
            currentSelectedQuestId = questId;
            const quest = questsData[questId];
            
            if (adminMode) renderAdminView(quest);
            else renderQuestView(quest);
            
            document.querySelectorAll('.quest-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.quest-item[data-quest-id='${questId}']`);
            if(activeItem) activeItem.classList.add('active');
        }

        function renderQuestView(quest) {
            questDetailContent.innerHTML = `
                <h2>${quest.title}</h2>
                <p class="quest-giver">${quest.giver || 'Ein Abgesandter des Spielmasters hat eine Nachricht für dich.'}</p>
                <p class="quest-objective">${quest.tasks || 'Objective'}</p>
                <h3>DESCRIPTION</h3>
                <p>${quest.description.replace(/\n/g, '<br>')}</p>
                <h3>REWARDS</h3>
                <p>${quest.reward.replace(/\n/g, '<br>')}</p>
            `;
        }

        function renderAdminView(quest) {
             questDetailContent.innerHTML = `
                <h2>Quest bearbeiten</h2>
                <div class="admin-form">
                    <label>Titel:</label>
                    <input type="text" id="admin-title" value="${quest.title}">
                    <label>Questgeber-Text:</label>
                    <input type="text" id="admin-giver" value="${quest.giver || ''}">
                    <label>Beschreibung:</label>
                    <textarea id="admin-description">${quest.description}</textarea>
                    <label>Aufgaben:</label>
                    <textarea id="admin-tasks">${quest.tasks}</textarea>
                    <label>Belohnung:</label>
                    <input type="text" id="admin-reward" value="${quest.reward}">
                    <label>Zusatz (z.B. XP):</label>
                    <input type="text" id="admin-xp" value="${quest.xp || ''}">
                    <label>Status:</label>
                    <select id="admin-status">
                        <option value="active" ${quest.status === 'active' ? 'selected' : ''}>Aktiv</option>
                        <option value="completed" ${quest.status === 'completed' ? 'selected' : ''}>Abgeschlossen</option>
                    </select>
                    <button class="admin-save-button" id="save-quest-btn">Speichern</button>
                </div>
            `;
            document.getElementById('save-quest-btn').addEventListener('click', () => saveQuestChanges(quest.id));
        }
        
        async function saveQuestChanges(questId) {
            const questRef = doc(db, "quests", questId);
            const saveData = {
                title: document.getElementById('admin-title').value,
                giver: document.getElementById('admin-giver').value,
                description: document.getElementById('admin-description').value,
                tasks: document.getElementById('admin-tasks').value,
                reward: document.getElementById('admin-reward').value,
                xp: document.getElementById('admin-xp').value,
                status: document.getElementById('admin-status').value
            };
            await updateDoc(questRef, saveData);
            adminMode = false;
            if (trackQuestBtn) trackQuestBtn.classList.remove('active');
            showQuestDetails(questId);
        }

        function setupEventListeners() {
            questListContent.addEventListener('click', (event) => {
                const questItem = event.target.closest('.quest-item');
                if (questItem) showQuestDetails(questItem.dataset.questId);
            });

            document.getElementById('abandon-btn').addEventListener('click', () => {
                const quotes = [
                    "Arise, my champion!", "You are not prepared!", "Tempest Keep was merely a setback.",
                    "By fire be purged!", "LEEROOOY JENKINS!", "Work is da poop! No more!",
                    "You no take candle!", "Me not that kind of orc.", "Stand in the fire, DPS is higher.",
                    "Less QQ, more pew pew.", "Did you think we had forgotten? Did you think we had forgiven?",
                    "Time is money, friend.", "Lok'tar ogar! Victory or death!",
                ];
                document.getElementById('modal-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
                document.getElementById('quote-modal').style.display = 'flex';
            });

            document.getElementById('share-btn').addEventListener('click', () => {
                const quest = questsData[currentSelectedQuestId];
                if (quest) {
                    const text = encodeURIComponent(`JGA-Quest: ${quest.title}`);
                    window.open(`https://wa.me/?text=${text}`, '_blank');
                }
            });

            if (trackQuestBtn) {
                trackQuestBtn.addEventListener('click', () => {
                    if (adminMode) return;
                    const password = prompt("Spielmaster-Passwort:");
                    if (password === 'HomoComo') {
                        adminMode = true;
                        trackQuestBtn.classList.add('active');
                        showQuestDetails(currentSelectedQuestId);
                    } else if (password) {
                        alert('Falsches Passwort!');
                    }
                });
            }

            document.getElementById('exit-btn').addEventListener('click', () => {
                 if (adminMode) {
                    adminMode = false;
                    if (trackQuestBtn) trackQuestBtn.classList.remove('active');
                    showQuestDetails(currentSelectedQuestId);
                }
            });

            // Close modal
            document.querySelector('.modal-close-btn').addEventListener('click', () => {
                document.getElementById('quote-modal').style.display = 'none';
            })
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
    
    <style>
        :root {
            --font-title: 'Cinzel Decorative', serif;
            --font-text: 'IM Fell Double Pica', serif;
            --color-gold: #ffd100;
            --color-text-light: #f0d890;
            --color-text-dark: #222;
            --color-quest-active: #fff;
            --color-quest-completed: #888;
            
            /* Lokale Asset-Pfade */
            --bg-image: url('https://images.alphacoders.com/488/48812.jpg');
            --questlog-background: url('assets/questlog_background.png');
            --icon-checkmark: url('assets/icon_checkmark.png');
            --icon-collapse: url('assets/icon_collapse.png');
            --scrollbar-thumb: url('assets/scrollbar_thumb.png');
        }
        body {
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            font-family: var(--font-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .questlog-container {
            width: 1024px;
            height: 700px;
            background-image: var(--questlog-background);
            background-size: 100% 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            position: relative;
            color: var(--color-text-light);
        }
        
        /* --- Header Elemente --- */
        .questlog-title {
            position: absolute;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-title);
            font-size: 18px;
            color: var(--color-text-light);
        }
        #quest-counter {
            position: absolute;
            top: 30px;
            right: 80px;
            font-family: var(--font-title);
            font-size: 14px;
        }
        #track-quest-btn {
            position: absolute;
            top: 100px;
            left: 100px;
            font-size: 14px;
            cursor: pointer;
            color: var(--color-quest-completed);
        }
        #track-quest-btn.active {
            color: var(--color-quest-active);
        }
        
        /* --- Hauptlayout --- */
        .questlog-main {
            display: flex;
            position: absolute;
            top: 70px;
            bottom: 70px;
            left: 30px;
            right: 30px;
            gap: 20px;
        }
        .quest-list-panel {
            width: 45%;
            overflow-y: auto;
            padding-right: 15px;
            margin-top: 50px; /* Platz für "Track Quest" */
        }
        .quest-detail-panel {
            width: 55%;
            overflow-y: auto;
            padding-right: 25px;
            font-size: 14px;
            line-height: 1.6;
        }
        .quest-category {
            display: flex;
            align-items: center;
            font-family: var(--font-title);
            color: var(--color-gold);
            font-size: 15px;
            margin: 15px 0 5px 0;
        }
        .quest-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            margin-left: 20px;
        }
        .quest-item.active {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .quest-title { color: var(--color-quest-active); }
        .quest-status { display: flex; align-items: center; color: var(--color-quest-completed); }
        
        .quest-detail-panel h2 {
            font-family: var(--font-title); font-size: 18px; color: #000; margin-top: 0;
        }
        .quest-detail-panel h3 {
            font-family: var(--font-title); font-size: 14px; color: #000; margin-top: 20px;
        }
        .quest-detail-panel p { color: var(--color-text-dark); }
        .quest-giver, .quest-objective { color: #50280a; font-weight: bold; }

        /* --- Footer Buttons --- */
        .questlog-button {
            position: absolute;
            bottom: 22px;
            padding: 8px 18px;
            font-family: var(--font-text);
            font-size: 14px;
            color: var(--color-gold);
            border: none;
            background: none;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        .questlog-button:hover { opacity: 0.7; }
        #abandon-btn { left: 45px; }
        #share-btn { left: 50%; transform: translateX(-50%); }
        #exit-btn { right: 45px; }
        
        .quest-icon {
            width: 16px; height: 16px; background-size: contain; background-repeat: no-repeat;
        }
        .icon-collapse { background-image: var(--icon-collapse); margin-right: 8px;}
        .icon-checkmark { background-image: var(--icon-checkmark); margin-left: 8px; }
        
        /* --- Admin Form --- */
        .admin-form { color: #000; }
        .admin-form label { display: block; margin-top: 10px; font-weight: bold; }
        .admin-form input, .admin-form textarea, .admin-form select {
            width: 100%; padding: 8px; font-size: 14px; border: 1px solid #887a61; box-sizing: border-box;
            border-radius: 3px;
        }
        .admin-form textarea { resize: vertical; min-height: 80px; }
        .admin-save-button {
            display: block; margin: 20px auto 0; padding: 10px 25px;
            font-family: var(--font-title); color: var(--color-gold);
            background-color: #3a2a1a; border: 1px solid var(--color-gold);
            border-radius: 5px; cursor: pointer;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 16px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background-color: #555; border: 1px solid #222; }
        ::-webkit-scrollbar-thumb:hover { background-color: #777; }

        /* --- Modal für Sprüche --- */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-image: url('assets/questlog_background.png');
            background-size: cover;
            padding: 40px;
            border: 2px solid var(--color-gold);
            max-width: 500px; text-align: center;
            font-size: 18px; color: var(--color-text-light);
            text-shadow: 1px 1px 3px #000;
        }
        .modal-close-btn {
            margin-top: 20px; padding: 8px 20px;
            font-family: var(--font-title); cursor: pointer;
            color: var(--color-gold); background-color: #3a2a1a;
            border: 1px solid var(--color-gold);
        }

    </style>
</head>
<body>
    <div class="questlog-container">
        <header>
            <div class="questlog-title">Quest Log</div>
            <div id="track-quest-btn">Track Quest</div>
            <div id="quest-counter">Quests: 0/25</div>
        </header>

        <main class="questlog-main">
            <div class="quest-list-panel">
                <div id="quest-list-content">
                    <div class="quest-category">Lade Quests...</div>
                </div>
            </div>
            <div class="quest-detail-panel" id="quest-detail-content"></div>
        </main>

        <footer>
            <button class="questlog-button" id="abandon-btn">Abandon Quest</button>
            <button class="questlog-button" id="share-btn">Share Quest</button>
            <button class="questlog-button" id="exit-btn">Exit</button>
        </footer>
    </div>

    <!-- Modal für "Abandon Quest" Sprüche -->
    <div id="quote-modal" class="modal">
        <div class="modal-content">
            <p id="modal-quote">Hier kommt ein Spruch hin.</p>
            <button class="modal-close-btn">Schließen</button>
        </div>
    </div>

</body>
</html>
