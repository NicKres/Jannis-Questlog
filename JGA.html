<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Die Chroniken von Alenia</title>
    <!-- Tailwind CSS CDN für schnelle Styling-Grundlagen -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts für einen Fantasy-Look -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=IM+Fell+Double+Pica:ital@0;1&family=Georgia&family=Lancelot&display=swap" rel="stylesheet">
    <style>
        /* --- Basis & Fonts --- */
        body {
            margin: 0;
            padding: 0;
            /* Hintergrundbild des gesamten Bildschirms, WoW-ähnlich (ohne externe Bilder, falls dies auch gemeint war) */
            background-color: #1a1a1a; /* Dunkler Hintergrund */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Sorgt für Full-Height */
            box-sizing: border-box;
            font-family: 'IM Fell Double Pica', serif; /* Standard-Schrift für Fließtext */
            color: #f0e6c8; /* Heller Standardtext für den Browser-Body */
            overflow: hidden; /* Verhindert Scrollbalken am Body */
        }

        /* --- Questlog Container (Das Hauptfenster) --- */
        .quest-log-container {
            display: flex;
            flex-direction: column;
            width: 90vw; /* 90% der Viewport-Breite */
            max-width: 960px; /* Max-Breite wie im WoW-UI üblich (Referenzbild-Proportion) */
            height: 85vh; /* 85% der Viewport-Höhe */
            max-height: 720px; /* Max-Höhe, typisch für WoW Fenster (Referenzbild-Proportion) */
            min-width: 650px; /* Mindestbreite, damit das Layout nicht zerbricht */
            min-height: 500px; /* Mindesthöhe */

            /* WoW Fensterrahmen-Effekt - Simuliert durch Rahmen und Schatten */
            background-color: #f7e6b7; /* Hellerer Pergament-Ton als Basis */
            background-image: radial-gradient(circle at 50% 0, rgba(255,255,255,0.1) 0%, transparent 70%),
                              radial-gradient(circle at 0% 100%, rgba(255,255,255,0.1) 0%, transparent 70%),
                              radial-gradient(circle at 100% 100%, rgba(255,255,255,0.1) 0%, transparent 70%),
                              radial-gradient(circle at 50% 100%, rgba(0,0,0,0.1) 0%, transparent 70%); /* Dezenter Verlauf für Tiefe */
            border: 2px solid #3d3d3d; /* Dunkelgrauer Rahmen */
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.9), inset 0 0 10px rgba(0, 0, 0, 0.5);
            position: relative; /* Für interne Positionierungen */
            overflow: hidden; /* Wichtig, damit Inhalte nicht über den Rahmen hinausgehen */
            /* resize: both; // ERMÖGLICHT GRÖSSENÄNDERUNG PER DRAG (optional, wurde in diesem Set entfernt) */
            /* overflow: auto; // Sorgt dafür, dass bei Resize gescrollt werden kann */

            /* Globale Pergament-Textfarbe und Schatten für den Container-Inhalt */
            color: #5a3b1a; /* Dunklerer Pergament-Text */
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.5); /* Leichter weißer Textschatten für Lesbarkeit */
        }

        /* --- Scrollbar Styling für das Hauptfenster (Webkit-Browser) --- */
        .quest-log-container::-webkit-scrollbar {
            width: 12px;
        }
        .quest-log-container::-webkit-scrollbar-track {
            background: #3a322a; /* Dunkle Spur */
            border-radius: 10px;
        }
        .quest-log-container::-webkit-scrollbar-thumb {
            background: #6a5d4a; /* Dunkles Holz */
            border-radius: 6px;
            border: 2px solid #4a3e2a;
        }
        .quest-log-container::-webkit-scrollbar-thumb:hover {
            background: #8a7d6a;
        }

        /* --- Oberer Header des Questlogs --- */
        .quest-log-header {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Elemente links beginnen */
            padding: 8px 15px; /* Etwas weniger Padding */
            background-color: #1a1a1a; /* Dunkler Balken wie im WoW-UI */
            border-bottom: 2px solid #4a3e2a; /* Trennlinie */
            flex-shrink: 0; /* Verhindert Schrumpfen des Headers */
            user-select: none; /* Verhindert Textauswahl, wie im UI */
            cursor: grab; /* Zeigt an, dass man es ziehen könnte (optional) */
        }
        .header-icon {
            width: 28px; /* Kleineres Icon */
            height: 28px;
            /* Hintergrundbild des Icons entfernt, da "ohne externe Bilder" */
            /* Ersetzt durch ein CSS-Symbol oder Text (z.B. ein Stern oder Buch-Emoji) */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em; /* Größe des Symbols */
            color: gold; /* Farbe des Symbols */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            margin-right: 8px;
            flex-shrink: 0;
        }
        .header-icon::before {
            content: "\1F4D6"; /* Unicode für geschlossenes Buch */
        }
        .header-title {
            font-family: 'Cinzel Decorative', serif; /* WoW-Titel-Schrift */
            font-size: 1.5em; /* Etwas kleiner als zuvor, wie im Referenzbild */
            color: #ffd100; /* Goldgelb */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            flex-grow: 1; /* Nimmt verfügbaren Platz ein */
            text-align: center; /* Zentriert den Titel im Header */
            margin-right: -40px; /* Korrektur für Icon-Platz */
        }
        .header-info {
            font-family: 'IM Fell Double Pica', serif;
            font-size: 0.9em; /* Kleiner */
            color: #a0a0a0; /* Grauton */
            white-space: nowrap;
            margin-left: auto; /* Schiebt es ganz nach rechts */
            padding-right: 15px; /* Abstand zum Rand */
        }
        .header-map-button {
            font-family: 'IM Fell Double Pica', serif;
            font-size: 0.9em;
            color: #ffd100;
            cursor: pointer;
            text-decoration: underline; /* Unterstrichen wie im UI */
            white-space: nowrap;
            padding: 0 5px; /* Kleinerer Klickbereich */
        }
        .header-map-button:hover {
            color: #ffffff; /* Heller bei Hover */
        }

        /* --- Hauptbereich (Linke Liste & Rechte Details) --- */
        .quest-log-main {
            display: flex;
            flex-grow: 1; /* Nimmt den restlichen Platz ein */
            overflow: hidden; /* Wichtig für interne Scrollbarkeit */
            /* border-top: 1px solid #4a3e2a; Entfällt, da schon im Header */
            background-color: rgba(0, 0, 0, 0.1); /* Ein dezenter Hintergrund für den Main-Bereich */
            border-bottom: 2px solid #4a3e2a; /* Trennlinie zum Footer */
        }

        /* --- Linke Quest-Liste --- */
        .quest-list-panel {
            width: 35%; /* Wie im Referenzbild */
            /* Hintergrund-Textur für linkes Panel (Pergament) */
            /* Hintergrundbilder entfernt, Pergament-Farbe wird vom Container übernommen */
            border-right: 2px solid #4a3e2a; /* Vertikale Trennlinie zwischen den Panels */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Für internes Scrollen */
        }
        .quest-list-scroll {
            flex-grow: 1;
            overflow-y: auto; /* Scrollen innerhalb der Quest-Liste */
            padding: 10px 15px; /* Innenabstand */
            box-sizing: border-box;
        }

        /* --- Rechte Quest-Detailansicht --- */
        .quest-detail-panel {
            width: 65%; /* Restliche Breite */
            /* Hintergrund-Textur für rechtes Panel (Pergament) */
            /* Hintergrundbilder entfernt, Pergament-Farbe wird vom Container übernommen */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Für internes Scrollen */
        }
        .quest-detail-scroll {
            flex-grow: 1;
            overflow-y: auto; /* Scrollen innerhalb der Details */
            padding: 15px 25px; /* Etwas mehr Padding rechts wie im Bild */
            box-sizing: border-box;
        }

        /* --- Scrollbar Styling für interne Panels (Webkit-Browser) --- */
        .quest-list-scroll::-webkit-scrollbar,
        .quest-detail-scroll::-webkit-scrollbar {
            width: 10px;
        }
        .quest-list-scroll::-webkit-scrollbar-track,
        .quest-detail-scroll::-webkit-scrollbar-track {
            background: #2a2a2a; /* Dunkle Spur */
        }
        .quest-list-scroll::-webkit-scrollbar-thumb,
        .quest-detail-scroll::-webkit-scrollbar-thumb {
            background: #5a4b3d; /* Dunkles Holz */
            border-radius: 5px;
            border: 1px solid #3a322a;
        }
        .quest-list-scroll::-webkit-scrollbar-thumb:hover,
        .quest-detail-scroll::-webkit-scrollbar-thumb:hover {
            background-color: #7a6e5a;
        }

        /* --- Styles für einzelne Quest-Items in der Liste --- */
        .quest-item {
            display: flex;
            align-items: center;
            padding: 6px 8px; /* Weniger Padding */
            margin-bottom: 3px; /* Weniger Abstand */
            cursor: pointer;
            white-space: nowrap; /* Titel in einer Zeile halten */
            overflow: hidden;
            text-overflow: ellipsis; /* ... wenn zu lang */
            font-family: 'IM Fell Double Pica', serif;
            color: #5a3b1a; /* Dunklerer Text für Liste (wie im Bild) */
            font-size: 0.95em;
            position: relative;
            transition: background-color 0.1s ease-out; /* Schnelleres Highlight */
        }
        .quest-item .quest-status {
            width: 20px; /* Kleinere Icons in der Liste wie im Bild */
            height: 20px;
            flex-shrink: 0;
            margin-right: 5px; /* Weniger Abstand */
            /* Hintergrundbilder entfernt, CSS-Simulation beibehalten */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Cinzel Decorative', serif; /* Schriftart für das Symbol */
            font-size: 1.1em; /* Größe des Symbols (!, ?, X) */
            font-weight: bold;
            color: white; /* Farbe des Symbols */
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
            border: 1px solid rgba(0,0,0,0.5);
        }

        /* --- Spezifische Farben für jeden Status in der Liste --- */
        .quest-item.aktiv .quest-status {
            background-color: #c48c1a; /* WoW-Gelb/Orange für aktive Quest */
        }
        .quest-item.abgeschlossen .quest-status {
            background-color: #4a4a4a; /* Grau für abgeschlossenes Quest */
        }
        .quest-item.fehlgeschlagen .quest-status {
            background-color: #8c0000; /* Dunkles Rot für fehlgeschlagenes Quest */
        }
        .quest-item.folgequest .quest-status {
            background-color: #c48c1a; /* Orange/Gold für Folgequest */
        }

        /* Text für Quest-Item in der Liste */
        .quest-item-title {
            color: #4a3e2a; /* Dunklerer Braunton */
            font-weight: normal; /* Normaler Font-Weight */
            flex-grow: 1; /* Nimmt restlichen Platz ein */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Hervorhebung (Hover & Ausgewählt) --- */
        .quest-item:hover {
            background-color: rgba(90, 75, 55, 0.3); /* Dezenter, transparenter Braunton beim Hover */
        }
        .quest-item.selected {
            /* Hintergrundbild entfernt, da "ohne externe Bilder" */
            background-color: rgba(90, 75, 55, 0.5); /* Intensiverer Braunton für ausgewählte Quest */
            border-color: gold; /* Goldener Rand */
            box-shadow: 0 0 5px gold, inset 0 0 5px rgba(255, 215, 0, 0.6);
            color: #ffd100; /* Heller Text für ausgewählte Quest */
            font-weight: bold; /* Fetter Text */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* Schatten für besseren Kontrast */
        }
        /* Auch der Icon-Farbeffekt beim Selected-Zustand */
        .quest-item.selected .quest-item-title {
            color: #ffd100; /* Goldgelb für ausgewählten Titel */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* --- Styles für den Quest-Detailbereich --- */
        #selected-quest-content {
            font-family: 'IM Fell Double Pica', serif;
            color: #5a3b1a; /* Dunklerer Text auf Pergament */
            line-height: 1.5; /* Etwas weniger Zeilenabstand */
            text-shadow: 0.5px 0.5px 0.5px rgba(255, 255, 255, 0.5); /* Heller Schatten */
        }
        .detail-title {
            font-family: 'Cinzel Decorative', serif; /* Großer Titel im Detailbereich */
            font-size: 1.8em; /* Größe wie im Referenzbild */
            color: #4a3e2a; /* Dunkler Braunton */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            margin-bottom: 15px;
            white-space: normal; /* Erlaubt Zeilenumbrüche, wie im Referenzbild */
            overflow: visible; /* Zeigt den ganzen Text */
            text-overflow: clip; /* Keine Ellipse */
        }
        .detail-description, .detail-action, .detail-reward {
            margin-bottom: 12px; /* Etwas weniger Abstand */
            font-size: 0.95em; /* Leicht kleiner als Standardtext */
        }
        .detail-reward-item { /* Belohnungseinträge */
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(74, 62, 42, 0.3);
            padding: 5px 10px;
            border-radius: 3px;
            margin-top: 8px;
        }
        .reward-icon {
            width: 24px; /* Kleinere Icons */
            height: 24px;
            /* background-image: url('https://wow.zamimg.com/images/wow/icons/large/inv_misc_bag_12.jpg'); Hintergrundbild entfernt */
            background-size: contain;
            background-repeat: no-repeat;
            margin-right: 8px;
            /* CSS-basierter Icon-Ersatz */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em; /* Größe des Symbols */
            color: #ffd100; /* Goldfarbe für Belohnungssymbole */
            text-shadow: 1px 1px 1px rgba(0,0,0,0.7);
        }
        .reward-icon::before {
            content: "\1F4B0"; /* Unicode für Geldsack */
        }
        .reward-text {
            font-weight: bold;
            color: #ffd100;
            font-size: 0.9em;
        }

        /* --- Unterer Footer mit Buttons --- */
        .quest-log-footer {
            display: flex;
            justify-content: space-around;
            padding: 8px 20px;
            background-color: #1a1a1a;
            border-top: 2px solid #4a3e2a;
            flex-shrink: 0;
        }
        .footer-button {
            background-color: #3a322a;
            color: #f0e6c8;
            border: 1px solid #5a4b3d;
            padding: 6px 12px; /* Kleinere Buttons */
            border-radius: 4px;
            cursor: pointer;
            font-family: 'IM Fell Double Pica', serif;
            font-size: 0.85em;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.7);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 2px 3px rgba(0,0,0,0.5);
            white-space: nowrap; /* Button-Text in einer Zeile */
        }
        .footer-button:hover {
            background-color: #5a4b3d;
            color: #ffffff;
        }
        .footer-button:active {
            background-color: #2a2a2a;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.7);
        }

        /* --- Hidden-Klasse --- */
        .hidden {
            display: none !important;
        }

        /* --- Drag-and-Drop Styles --- */
        .quest-item.dragging {
            opacity: 0.4;
            border: 2px dashed #d4af37; /* Gold dashed border when dragging */
        }

        .quest-item.drag-over {
            border: 2px solid dodgerblue; /* Blue border when dragged over */
            transform: scale(1.02);
        }

        /* --- Responsive Anpassungen (für kleinere Bildschirme) --- */
        @media (max-width: 768px) {
            .quest-log-container {
                width: 98vw; /* Füllt fast die ganze Breite */
                height: 98vh; /* Füllt fast die ganze Höhe */
                min-width: unset; /* Keine Mindestbreite mehr */
                min-height: unset; /* Keine Mindesthöhe mehr */
                border-radius: 0; /* Keine Rundung an den Ecken auf Mobile */
            }
            .quest-log-header {
                padding: 5px 8px;
            }
            .header-icon {
                width: 24px;
                height: 24px;
                font-size: 1.2em;
            }
            .header-title {
                font-size: 1.3em;
            }
            .header-info, .header-map-button {
                font-size: 0.8em;
            }
            .quest-log-main {
                flex-direction: column; /* Panels untereinander auf kleinen Bildschirmen */
            }
            .quest-list-panel, .quest-detail-panel {
                width: 100%; /* Nehmen volle Breite ein */
                border: none; /* Keine Ränder zwischen den Panels */
                border-radius: 0;
                margin-bottom: 0; /* Kein zusätzlicher Abstand */
            }
            .quest-list-panel {
                height: 40vh; /* Liste nimmt 40% der Höhe ein */
                max-height: unset; /* Keine Max-Höhe hier */
            }
            .quest-detail-panel {
                height: 60vh; /* Details nehmen 60% der Höhe ein */
            }
            .quest-list-scroll, .quest-detail-scroll {
                padding: 8px;
            }
            .quest-item {
                font-size: 0.9em;
                padding: 5px 8px;
            }
            .quest-item .quest-status {
                width: 16px;
                height: 16px;
                font-size: 0.9em;
            }
            .detail-title {
                font-size: 1.5em;
            }
            .detail-description, .detail-action, .detail-reward {
                font-size: 0.9em;
            }
            .footer-button {
                font-size: 0.75em;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="quest-log-container">
        <!-- Loading Overlay (unverändert beibehalten) -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <p>Lade Quests...</p>
        </div>

        <div class="quest-log-header">
            <div class="header-icon"></div> <!-- Icon wird per CSS gesetzt -->
            <div class="header-title">Quest Log</div>
            <div class="header-info">Quests: <span id="quests-count">0/0</span></div>
            <div class="header-map-button">Show Map</div>
            <!-- Schließen-Button in den Header verschoben, da die Überschrift eine eigene Struktur ist -->
            <button class="close-button" id="closeButton">X</button>
        </div>

        <!-- Sortierungsoptionen (Nur sichtbar im Bearbeitungsmodus) - Beibehalten, da es eine Funktion ist -->
        <div id="sortPanel" class="p-4 bg-gray-700 border-b border-gray-600 flex flex-wrap justify-end items-center gap-4 hidden">
            <label for="sortCriteria" class="text-gold-300">Sortieren nach:</label>
            <select id="sortCriteria" class="editable-field w-auto min-w-[150px]">
                <option value="titleAsc">Titel (A-Z)</option>
                <option value="titleDesc">Titel (Z-A)</option>
                <option value="status">Status</option>
                <option value="customOrder">Benutzerdefinierte Reihenfolge</option>
            </select>
            <button id="sortButton" class="action-button">Sortieren</button>
        </div>

        <div class="quest-log-main">
            <div class="quest-list-panel">
                <div class="quest-list-scroll" id="quest-list-scroll">
                    <!-- Quests werden hier dynamisch eingefügt -->
                </div>
            </div>

            <div class="quest-detail-panel">
                <div class="quest-detail-scroll" id="quest-detail-scroll">
                    <div id="selected-quest-content">
                        <h3 class="detail-title">Willkommen im Quest Log!</h3>
                        <p class="detail-description">Wähle eine Quest aus der Liste auf der linken Seite, um Details über deine Missionen zu erfahren.</p>
                        <!-- Hinzugefügte Elemente für Action, Reward, Note -->
                        <p class="detail-action"><b>Aktion:</b><br>Wähle eine Quest.</p>
                        <p class="detail-reward"><b>Belohnung:</b><br>Wähle eine Quest.</p>
                        <p class="detail-note"><b>Anmerkung:</b> Wähle eine Quest.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="quest-log-footer">
            <button class="footer-button">Abandon</button>
            <button class="footer-button">Share</button>
            <button class="footer-button">Track</button>
            <!-- Passwort-Panel in den Footer verschoben (war schon da, nur für Konsistenz) -->
            <div id="passwordPanel" class="password-panel ml-auto"> <!-- ml-auto schiebt es nach rechts -->
                <label for="passwordInput" class="text-gold-300 text-sm font-bold">Passwort für Bearbeitung:</label>
                <input type="password" id="passwordInput" class="password-input" placeholder="Passwort">
                <button id="enterEditModeButton" class="action-button-small">Login</button>
            </div>
        </div>
    </div>

    <!-- Meldungsbox für Bestätigungen/Fehler (unverändert beibehalten) -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button id="messageBoxCloseButton">OK</button>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM-Elemente abrufen
        const questListScrollElement = document.getElementById('quest-list-scroll');
        const selectedQuestContentElement = document.getElementById('selected-quest-content');
        const questsCountElement = document.getElementById('quests-count');
        const questDetailsPanel = document.getElementById('quest-detail-panel'); // Aktualisierter ID-Referenz

        // Edit Mode Elemente
        const detailsTitleEditMode = document.getElementById('detailsTitleEditMode'); // Dieser wird nicht mehr in der neuen Struktur verwendet
        const questTitleInput = document.getElementById('questTitleInput');
        const questDescriptionTextarea = document.getElementById('questDescriptionTextarea');
        const questObjectivesTextarea = document.getElementById('questObjectivesTextarea');
        const questRewardInput = document.getElementById('questRewardInput');
        const questStatusSelect = document.getElementById('questStatusSelect');
        const addQuestButton = document.getElementById('addQuestButton');
        const saveQuestButton = document.getElementById('saveQuestButton');
        const deleteQuestButton = document.getElementById('deleteQuestButton');
        const editModeFields = document.getElementById('editModeFields'); // Container für Edit-Felder

        // Read-only Mode Elemente
        const detailsTitleReadOnly = document.getElementById('detailsTitleReadOnly'); // Dieser wird nicht mehr in der neuen Struktur verwendet
        const roDescription = document.getElementById('roDescription');
        const roObjectivesContainer = document.getElementById('roObjectivesContainer');
        const roReward = document.getElementById('roReward');
        const roStatus = document.getElementById('roStatus');
        const readOnlyFields = document.getElementById('readOnlyFields'); // Container für Read-only-Felder

        // Passwort und Modus-Steuerung
        const passwordInput = document.getElementById('passwordInput');
        const enterEditModeButton = document.getElementById('enterEditModeButton');
        const passwordPanel = document.getElementById('passwordPanel');
        const correctPassword = 'HomoComo'; // Das festgelegte Passwort

        // Sortierungs-Elemente
        const sortCriteriaSelect = document.getElementById('sortCriteria');
        const sortButton = document.getElementById('sortButton');
        const sortPanel = document.getElementById('sortPanel');

        // Allgemeine Elemente
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');
        const closeButton = document.getElementById('closeButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let quests = []; // Hier werden die aus Firebase geladenen Quests gespeichert
        let selectedQuestId = null; // ID der aktuell ausgewählten Quest
        let isEditMode = false; // Steuert den Modus (Bearbeiten vs. Nur-Ansicht)
        let typingTimeout; // Für den Schreibeffekt
        let draggedItem = null; // Aktuell gezogenes Element für Drag-and-Drop

        // Firebase Initialisierung
        const firebaseConfig = {
            apiKey: "AIzaSyChyA0KQQMG0M4SnaHIdxwguJH8dYYDO-w",
            authDomain: "wowquestlogprojekt.firebaseapp.com",
            projectId: "wowquestlogprojekt",
            storageBucket: "wowquestlogprojekt.firebasestorage.app",
            messagingSenderId: "689308532820",
            appId: "1:689308532820:web:0523701ea7c790a8c6adc1",
            measurementId: "G-XXXXXXXXXX" // OPTIONAL: Ersetze dies durch deine Measurement ID, falls du Google Analytics nutzt
        };
        const appId = firebaseConfig.projectId; // Für GitHub Pages: Verwende die projectId als appId


        let app;
        let db;
        let auth;
        let currentUserId = null;
        let questCollectionRef;
        let isFirebaseReady = false; // Flag, das anzeigt, ob Firebase bereit ist

        /**
         * Zeigt eine Ladeanzeige an.
         */
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        /**
         * Verbirgt die Ladeanzeige.
         */
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        /**
         * Zeigt eine Meldungsbox mit einer Nachricht an.
         * @param {string} message - Die anzuzeigende Nachricht.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.add('show');
        }

        /**
         * Verbirgt die Meldungsbox.
         */
        function hideMessageBox() {
            messageBox.classList.remove('show');
        }

        /**
         * Initialisiert Firebase und lädt Quests.
         */
        async function initializeFirebaseAndLoadQuests() {
            showLoading();
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                questCollectionRef = collection(db, `artifacts/${appId}/public/data/quests`);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `User ID: ${currentUserId}`;
                        isFirebaseReady = true;
                        loadQuestsFromFirebase();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessageBox("Fehler bei der Authentifizierung: " + error.message);
                            hideLoading();
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessageBox("Fehler beim Initialisieren von Firebase: " + error.message);
                hideLoading();
            }
        }

        /**
         * Lädt Quests von Firestore.
         */
        function loadQuestsFromFirebase() {
            if (!isFirebaseReady) return;

            onSnapshot(questCollectionRef, (snapshot) => {
                const fetchedQuests = [];
                snapshot.forEach(doc => {
                    fetchedQuests.push({ id: doc.id, ...doc.data() });
                });

                quests = fetchedQuests.sort((a, b) => {
                    const orderA = a.order !== undefined ? a.order : Number.MAX_SAFE_INTEGER;
                    const orderB = b.order !== undefined ? b.order : Number.MAX_SAFE_INTEGER;
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    return (a.createdAt || '').localeCompare(b.createdAt || '');
                });

                updateUIForMode();
                renderQuestList();

                const totalQuestsCount = quests.length;
                const activeQuestsCount = quests.filter(q => q.status === 'aktiv').length;
                questsCountElement.textContent = `${activeQuestsCount}/${totalQuestsCount}`;


                if (quests.length > 0) {
                    const previouslySelected = quests.find(q => q.id === selectedQuestId);
                    const initialSelectableQuest = isEditMode
                        ? (previouslySelected || quests[0])
                        : (previouslySelected || quests.find(q => q.status === 'aktiv' || q.status === 'abgeschlossen'));

                    if (initialSelectableQuest) {
                        selectQuest(initialSelectableQuest.id);
                    } else {
                        // clearQuestDetails(); // Verhindert Rekursion
                        selectedQuestContentElement.innerHTML = `
                            <h3 class="detail-title">Willkommen im Quest Log!</h3>
                            <p class="detail-description">Wähle eine Quest aus der Liste auf der linken Seite, um Details über deine Missionen zu erfahren.</p>
                            <p class="detail-action"><b>Aktion:</b><br>Wähle eine Quest.</p>
                            <p class="detail-reward"><b>Belohnung:</b><br>Wähle eine Quest.</p>
                            <p class="detail-note"><b>Anmerkung:</b> Wähle eine Quest.</p>
                        `;
                    }
                } else {
                    // clearQuestDetails(); // Verhindert Rekursion
                    selectedQuestContentElement.innerHTML = `
                        <h3 class="detail-title">Willkommen im Quest Log!</h3>
                        <p class="detail-description">Wähle eine Quest aus der Liste auf der linken Seite, um Details über deine Missionen zu erfahren.</p>
                        <p class="detail-action"><b>Aktion:</b><br>Wähle eine Quest.</p>
                        <p class="detail-reward"><b>Belohnung:</b><br>Wähle eine Quest.</p>
                        <p class="detail-note"><b>Anmerkung:</b> Wähle eine Quest.</p>
                    `;

                    if (isEditMode) {
                        const initialQuests = [
                            {
                                title: 'Die Suche nach Mankriks Frau',
                                description: 'Finde Mankriks Frau, sie ist irgendwo in den Brachlanden verloren gegangen. Sie wurde zuletzt in der Nähe der Road in The Barrens gesehen. Sieh dich in der Nähe der Oasen um.',
                                objectives: ['Finde Mankriks Frau (0/1)'],
                                reward: '20 Silbermünzen, 100 Ruf bei der Horde',
                                status: 'aktiv',
                                createdAt: new Date().toISOString(),
                                order: 0
                            },
                            {
                                title: 'Töte 10 Wildschweine',
                                description: 'Die Gegend um Durotar ist von Wildschweinen überrannt. Bring uns ihre Stoßzähne als Beweis.',
                                objectives: ['Erlege 10 Wildschweine (10/10)', 'Sammle 10 Stoßzähne (10/10)'],
                                reward: '35 Silbermünzen, Lederhandschuhe',
                                status: 'abgeschlossen',
                                createdAt: new Date().toISOString(),
                                order: 1
                            },
                            {
                                title: 'Die Geheimnisse des dunklen Waldes',
                                description: 'Ein alter Druide sprach von seltsamen Vorkommnissen tief im Wald von Elwynn. Untersuche die Quelle der Verderbnis.',
                                objectives: ['Finde die Quelle der Verderbnis (0/1)', 'Berichte dem Druiden (0/1)'],
                                reward: 'Leichter Heiltrank, 50 Ruf bei der Allianz',
                                status: 'folgequest',
                                createdAt: new Date().toISOString(),
                                order: 2
                            }
                        ];

                        initialQuests.forEach(async (q) => {
                            try {
                                await addDoc(questCollectionRef, q);
                            } catch (e) {
                                console.error("Fehler beim Hinzufügen der initialen Quest: ", e);
                            }
                        });
                        showMessageBox('Initiale Quests hinzugefügt. Lade neu...');
                    }
                }
                hideLoading();
            }, (error) => {
                console.error("Fehler beim Laden der Quests von Firestore:", error);
                showMessageBox("Fehler beim Laden der Quests: " + error.message);
                hideLoading();
            });
        }

        /**
         * Aktualisiert die Sichtbarkeit der UI-Elemente basierend auf dem aktuellen Modus.
         */
        function updateUIForMode() {
            if (isEditMode) {
                // Diese Elemente sind jetzt direkt im selected-quest-content Element
                // und müssen nur mit den richtigen Werten befüllt werden, wenn der Edit-Modus aktiv ist.
                // Ihre Sichtbarkeit wird nicht direkt über hidden-Klassen gesteuert.
                // Stattdessen wird der Content dynamisch in selectQuest gerendert.

                // Die Sortier-Optionen sind sichtbar im Edit-Modus
                sortPanel.classList.remove('hidden');
                passwordPanel.classList.add('hidden'); // Passwort-Panel ausblenden
            } else {
                sortPanel.classList.add('hidden'); // Sortieroptionen im Ansichtsmodus verstecken
                passwordPanel.classList.remove('hidden'); // Passwort-Panel einblenden
            }
            // Buttons und Input-Felder müssen individuell im selectQuest befüllt/geleert/aktiviert werden.
            // Der Edit-Mode-Container (`editModeFields`) und Read-Only-Container (`readOnlyFields`)
            // sind in der neuen Struktur nicht mehr direkt die Obercontainer der Formularfelder,
            // sondern ihre Logik ist in `selectQuest` verlagert worden.
            // Die Button-Zustände werden unten am Ende von `selectQuest` und `clearQuestDetails` gesetzt.
        }

        /**
         * Rendert die Liste der Quests im linken Panel.
         * Fügt Drag-and-Drop-Attribute und Listener hinzu.
         */
        function renderQuestList() {
            questListScrollElement.innerHTML = ''; // Leere die Liste vor dem Neuladen
            if (quests.length === 0) {
                const noQuestsMsg = document.createElement('p');
                noQuestsMsg.className = 'text-center text-gray-500 italic mt-4';
                noQuestsMsg.textContent = 'Keine Quests vorhanden. Füge eine neue hinzu!';
                questListScrollElement.appendChild(noQuestsMsg);
                return;
            }

            quests.forEach(quest => {
                const questItemDiv = document.createElement('div');
                let itemClasses = `quest-item ${quest.status}`; // Fügt Status-Klasse hinzu
                if (quest.id === selectedQuestId) {
                    itemClasses += ' selected'; // Fügt "selected"-Klasse hinzu
                }

                // Im Ansichtsmodus "Folgequests" abblenden und nicht klickbar machen
                if (!isEditMode && quest.status === 'folgequest') {
                    itemClasses += ' dimmed-quest'; // Klasse für visuellen Effekt
                }

                questItemDiv.className = itemClasses;
                questItemDiv.setAttribute('data-id', quest.id);

                // Drag-and-Drop Attribute nur im Bearbeitungsmodus
                if (isEditMode) {
                    questItemDiv.setAttribute('draggable', 'true');
                    questItemDiv.addEventListener('dragstart', handleDragStart);
                    questItemDiv.addEventListener('dragover', handleDragOver);
                    questItemDiv.addEventListener('dragleave', handleDragLeave);
                    questItemDiv.addEventListener('drop', handleDrop);
                    questItemDiv.addEventListener('dragend', handleDragEnd);
                }

                // Bestimme das Symbol basierend auf dem Status
                let statusSymbol = '';
                switch(quest.status) {
                    case 'aktiv':
                        statusSymbol = '!';
                        break;
                    case 'abgeschlossen':
                        statusSymbol = '?';
                        break;
                    case 'fehlgeschlagen':
                        statusSymbol = 'X';
                        break;
                    case 'folgequest':
                        statusSymbol = '?';
                        break;
                    default:
                        statusSymbol = '';
                }

                questItemDiv.innerHTML = `
                    <div class="quest-status ${quest.status}">${statusSymbol}</div>
                    <span class="quest-item-title">${quest.title}</span>
                `;

                // Klick-Event Listener für jedes Quest-Item
                // Event Listener nur hinzufügen, wenn im Bearbeitungsmodus ODER wenn keine "Folgequest" im Ansichtsmodus
                if (isEditMode || (quest.status !== 'folgequest' && quest.status !== 'ausgeblendet')) {
                    questItemDiv.addEventListener('click', () => selectQuest(quest.id));
                }

                questListScrollElement.appendChild(questItemDiv);
            });
        }

        /**
         * Implementiert einen Schreibeffekt für einen Text.
         * @param {HTMLElement} element - Das HTML-Element, in das der Text geschrieben werden soll.
         * @param {string} text - Der vollständige Text, der geschrieben werden soll.
         * @param {number} delay - Verzögerung zwischen den Zeichen in ms.
         * @returns {Promise<void>} - Ein Promise, das erfüllt wird, wenn der Schreibeffekt abgeschlossen ist.
         */
        function typeText(element, text, delay = 30) {
            return new Promise(resolve => {
                if (typingTimeout) clearTimeout(typingTimeout);
                element.textContent = '';
                let i = 0;
                function type() {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                        typingTimeout = setTimeout(type, delay);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

        /**
         * Lädt die Details einer ausgewählten Quest in das rechte Panel.
         * @param {Object} questData - Das Datenobjekt der Quest.
         */
        function loadQuestDetails(questData) {
            // Dies ist die primäre Funktion zum Aktualisieren des rechten Panels
            // je nach Modus (Edit vs. Read-Only).
            let detailHtml = '';

            if (isEditMode) {
                detailHtml = `
                    <h3 class="detail-title" id="detailsTitleEditMode">${questData.title}</h3>
                    <label for="questTitleInput" class="text-gold-300">Quest Titel:</label>
                    <input type="text" id="questTitleInput" class="editable-field" placeholder="Quest Titel" value="${questData.title}">

                    <label for="questDescriptionTextarea" class="text-gold-300">Beschreibung:</label>
                    <textarea id="questDescriptionTextarea" class="editable-field" rows="6" placeholder="Beschreibung">${questData.description}</textarea>

                    <label for="questObjectivesTextarea" class="text-gold-300">Ziele (eine pro Zeile):</label>
                    <textarea id="questObjectivesTextarea" class="editable-field" rows="4" placeholder="Ziele (eine pro Zeile)">${Array.isArray(questData.objectives) ? questData.objectives.join('\n') : ''}</textarea>

                    <label for="questRewardInput" class="text-gold-300">Belohnung:</label>
                    <input type="text" id="questRewardInput" class="editable-field" placeholder="Belohnung für die Quest" value="${questData.reward}">

                    <label for="questStatusSelect" class="text-gold-300">Status:</label>
                    <select id="questStatusSelect" class="editable-field">
                        <option value="aktiv" ${questData.status === 'aktiv' ? 'selected' : ''}>Aktiv</option>
                        <option value="abgeschlossen" ${questData.status === 'abgeschlossen' ? 'selected' : ''}>Abgeschlossen</option>
                        <option value="fehlgeschlagen" ${questData.status === 'fehlgeschlagen' ? 'selected' : ''}>Fehlgeschlagen</option>
                        <option value="folgequest" ${questData.status === 'folgequest' ? 'selected' : ''}>Folgequest</option>
                    </select>

                    <div class="button-group">
                        <button class="action-button" id="addQuestButton">Neue Quest</button>
                        <button class="action-button" id="saveQuestButton">Änderungen speichern</button>
                        <button class="action-button delete-button" id="deleteQuestButton">Quest löschen</button>
                    </div>
                `;
            } else { // Read-only mode
                const objectivesHtml = Array.isArray(questData.objectives) ? questData.objectives.map(obj => `<li>${obj}</li>`).join('') : '';

                detailHtml = `
                    <h3 class="detail-title" id="detailsTitleReadOnly">${questData.title}</h3>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Beschreibung:</p>
                        <p id="roDescription" class="read-only-text"></p>
                    </div>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Ziele:</p>
                        <div id="roObjectivesContainer" class="read-only-text">${objectivesHtml}</div>
                    </div>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Belohnung:</p>
                        <p id="roReward" class="read-only-text"></p>
                    </div>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Status:</p>
                        <p id="roStatus" class="read-only-text"></p>
                    </div>
                `;
            }

            selectedQuestContentElement.innerHTML = detailHtml;

            // Nach dem Rendern der Elemente, wenn im Edit-Modus, die Event-Listener neu zuweisen
            if (isEditMode) {
                document.getElementById('addQuestButton').addEventListener('click', addQuest);
                document.getElementById('saveQuestButton').addEventListener('click', saveQuestChanges);
                document.getElementById('deleteQuestButton').addEventListener('click', deleteQuest);
                // Status der Buttons basierend auf Auswahl und Modus setzen
                const selected = selectedQuestId !== null;
                document.getElementById('saveQuestButton').disabled = !selected;
                document.getElementById('deleteQuestButton').disabled = !selected;
                document.getElementById('addQuestButton').disabled = false; // Add-Button ist immer aktiv im Edit Mode
            } else { // Read-only mode: Schreibeffekt triggern
                typeText(document.getElementById('roDescription'), questData.description);
                typeText(document.getElementById('roObjectivesContainer'), Array.isArray(questData.objectives) ? questData.objectives.map(obj => `• ${obj}`).join('\n') : '');
                typeText(document.getElementById('roReward'), questData.reward);
                typeText(document.getElementById('roStatus'), questData.status.charAt(0).toUpperCase() + questData.status.slice(1));
            }

            // Scroll nach oben
            document.getElementById('quest-detail-scroll').scrollTop = 0;
            renderQuestList(); // Stellt sicher, dass die Auswahl in der Liste visuell korrekt ist
        }

        /**
         * Wählt eine Quest aus und zeigt ihre Details an.
         * @param {string} id - Die ID der ausgewählten Quest.
         */
        function selectQuest(id) {
            // Alten Selektions-Status entfernen
            if (currentSelectedQuestId) {
                const prevSelectedItem = document.querySelector(`.quest-item[data-id="${currentSelectedQuestId}"]`);
                if (prevSelectedItem) {
                    prevSelectedItem.classList.remove('selected');
                }
            }

            selectedQuestId = id;
            const quest = quests.find(q => q.id === id);

            if (!quest) {
                clearQuestDetails();
                return;
            }

            // Im Ansichtsmodus: Wenn es eine "Folgequest" ist, nicht die Details anzeigen
            if (!isEditMode && quest.status === 'folgequest') {
                clearQuestDetails();
                showMessageBox('Diese Quest ist noch nicht aktiv. Du kannst nur den Titel sehen.');
                selectedQuestId = null; // Verhindert die visuelle Auswahl in der Liste
                renderQuestList(); // Liste neu rendern, um Auswahl aufzuheben
                return;
            }

            loadQuestDetails(quest); // Rufe die zentrale Ladefunktion auf
        }


        /**
         * Leert die Detailansicht.
         */
        function clearQuestDetails() {
            if (typingTimeout) clearTimeout(typingTimeout);

            selectedQuestId = null; // Setzt die ausgewählte Quest zurück

            // Standard-Willkommens-Inhalt anzeigen
            selectedQuestContentElement.innerHTML = `
                <h3 class="detail-title">Willkommen im Quest Log!</h3>
                <p class="detail-description">Wähle eine Quest aus der Liste auf der linken Seite, um Details über deine Missionen zu erfahren.</p>
                <p class="detail-action"><b>Aktion:</b><br>Wähle eine Quest.</p>
                <p class="detail-reward"><b>Belohnung:</b><br>Wähle eine Quest.</p>
                <p class="detail-note"><b>Anmerkung:</b> Wähle eine Quest.</p>
            `;

            // Im Edit-Modus die Buttons für den leeren Zustand setzen
            if (isEditMode) {
                document.getElementById('addQuestButton').addEventListener('click', addQuest);
                document.getElementById('saveQuestButton').addEventListener('click', saveQuestChanges);
                document.getElementById('deleteQuestButton').addEventListener('click', deleteQuest);
                document.getElementById('saveQuestButton').disabled = true;
                document.getElementById('deleteQuestButton').disabled = true;
                document.getElementById('addQuestButton').disabled = false;
            }

            // Alten Selektions-Status in der Liste entfernen
            const prevSelectedItem = document.querySelector(`.quest-item.selected`);
            if (prevSelectedItem) {
                prevSelectedItem.classList.remove('selected');
            }
        }


        /**
         * Fügt eine neue leere Quest hinzu (in Firestore).
         */
        async function addQuest() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Bitte warten Sie.");
                return;
            }
            showLoading();
            try {
                const maxOrder = quests.length > 0 ? Math.max(...quests.map(q => q.order || 0)) : -1;
                const newQuest = {
                    title: 'Neue Quest',
                    description: 'Dies ist eine brandneue Quest. Bearbeite die Details!',
                    objectives: ['Erstes Ziel (0/1)'],
                    reward: 'Unbekannt',
                    status: 'aktiv',
                    action: 'Keine Aktion definiert', // Hinzugefügte Felder für die neue Struktur
                    note: '', // Hinzugefügte Felder
                    createdAt: new Date().toISOString(),
                    order: maxOrder + 1
                };
                const docRef = await addDoc(questCollectionRef, newQuest);
                selectedQuestId = docRef.id; // Wähle die neue Quest aus
                showMessageBox('Neue Quest hinzugefügt!');
                // Die onSnapshot wird die Liste neu laden und selectQuest aufrufen.
            } catch (e) {
                console.error("Fehler beim Hinzufügen der Quest: ", e);
                showMessageBox("Fehler beim Hinzufügen der Quest: " + e.message);
            } finally {
                hideLoading();
            }
        }

        /**
         * Speichert die Änderungen an der aktuell ausgewählten Quest (in Firestore).
         */
        async function saveQuestChanges() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Bitte warten Sie.");
                return;
            }
            if (!selectedQuestId) {
                showMessageBox('Bitte wähle eine Quest zum Speichern aus.');
                return;
            }

            showLoading();
            try {
                // Zugriff auf die Werte der Input-Felder nach dem HTML-Update in loadQuestDetails
                const currentQuestTitleInput = document.getElementById('questTitleInput');
                const currentQuestDescriptionTextarea = document.getElementById('questDescriptionTextarea');
                const currentQuestObjectivesTextarea = document.getElementById('questObjectivesTextarea');
                const currentQuestRewardInput = document.getElementById('questRewardInput');
                const currentQuestStatusSelect = document.getElementById('questStatusSelect');

                const updatedQuestData = {
                    title: currentQuestTitleInput.value,
                    description: currentQuestDescriptionTextarea.value,
                    objectives: currentQuestObjectivesTextarea.value.split('\n').filter(line => line.trim() !== ''),
                    reward: currentQuestRewardInput.value,
                    status: currentQuestStatusSelect.value,
                    updatedAt: new Date().toISOString(),
                    // Action und Note hinzugefügt, ggf. aus separaten Feldern auslesen oder als leere Strings beibehalten
                    action: quests.find(q => q.id === selectedQuestId)?.action || 'Keine Aktion definiert',
                    note: quests.find(q => q.id === selectedQuestId)?.note || ''
                };

                const existingQuest = quests.find(q => q.id === selectedQuestId);
                if (existingQuest && existingQuest.order !== undefined) {
                    updatedQuestData.order = existingQuest.order;
                } else {
                    updatedQuestData.order = quests.length > 0 ? Math.max(...quests.map(q => q.order || 0)) + 1 : 0;
                }

                await setDoc(doc(db, `artifacts/${appId}/public/data/quests`, selectedQuestId), updatedQuestData, { merge: true });

                // Optimistische UI-Aktualisierung
                const localQuest = quests.find(q => q.id === selectedQuestId);
                if (localQuest) {
                    Object.assign(localQuest, updatedQuestData);
                }
                renderQuestList(); // Liste aktualisieren (Titel, Status)
                selectQuest(selectedQuestId); // Details aktualisieren

                showMessageBox('Änderungen gespeichert!');
            } catch (e) {
                console.error("Fehler beim Speichern der Änderungen: ", e);
                showMessageBox("Fehler beim Speichern der Änderungen: " + e.message);
            } finally {
                hideLoading();
            }
        }

        /**
         * Löscht die aktuell ausgewählte Quest (in Firestore).
         */
        async function deleteQuest() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Bitte warten Sie.");
                return;
            }
            if (!selectedQuestId) {
                showMessageBox('Bitte wähle eine Quest zum Löschen aus.');
                return;
            }

            showMessageBox('Soll diese Quest wirklich gelöscht werden?');
            messageBoxCloseButton.textContent = 'Ja';
            const originalCloseHandler = messageBoxCloseButton.onclick;
            messageBoxCloseButton.onclick = async () => {
                showLoading();
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/quests`, selectedQuestId));
                    selectedQuestId = null; // Quest wurde gelöscht, Auswahl zurücksetzen
                    showMessageBox('Quest gelöscht!');
                } catch (e) {
                    console.error("Fehler beim Löschen der Quest: ", e);
                    showMessageBox("Fehler beim Löschen der Quest: " + e.message);
                } finally {
                    hideLoading();
                    messageBoxCloseButton.textContent = 'OK';
                    messageBoxCloseButton.onclick = originalCloseHandler;
                }
                hideMessageBox();
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Nein';
            cancelButton.className = 'action-button delete-button ml-2';
            cancelButton.onclick = () => {
                hideMessageBox();
                messageBoxCloseButton.textContent = 'OK';
                messageBoxCloseButton.onclick = originalCloseHandler;
                cancelButton.remove();
            };
            messageBox.appendChild(cancelButton);
        }

        /**
         * Sortiert die Quests basierend auf dem ausgewählten Kriterium (in memory).
         */
        function sortQuests() {
            const criteria = sortCriteriaSelect.value;
            if (criteria === 'titleAsc') {
                quests.sort((a, b) => a.title.localeCompare(b.title));
            } else if (criteria === 'titleDesc') {
                quests.sort((a, b) => b.title.localeCompare(a.title));
            } else if (criteria === 'status') {
                const statusOrder = { 'aktiv': 1, 'fehlgeschlagen': 2, 'folgequest': 3, 'abgeschlossen': 4 };
                quests.sort((a, b) => {
                    const statusA = statusOrder[a.status] || 99;
                    const statusB = statusOrder[b.status] || 99;
                    if (statusA === statusB) {
                        return a.title.localeCompare(b.title);
                    }
                    return statusA - statusB;
                });
            } else if (criteria === 'customOrder') {
                // Bei "Benutzerdefinierte Reihenfolge" wird die initiale Sortierung nach "order" beibehalten.
                // Es ist nicht nötig, hier extra zu sortieren, da `loadQuestsFromFirebase` dies bereits tut.
                // Wir rendern nur neu, um sicherzustellen, dass die Ansicht aktualisiert wird.
            }
            renderQuestList();
            showMessageBox('Quests sortiert!');
        }

        // --- Drag-and-Drop Funktionen ---
        function handleDragStart(e) {
            if (!isEditMode) return;
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);

            setTimeout(() => {
                this.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            if (!isEditMode) return;
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (!isEditMode) return;
            this.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            if (!isEditMode) return;
            e.preventDefault();
            this.classList.remove('drag-over');

            if (this !== draggedItem) {
                const draggedId = e.dataTransfer.getData('text/plain');
                const droppedOnId = this.dataset.id;

                const draggedIndex = quests.findIndex(q => q.id === draggedId);
                const droppedOnIndex = quests.findIndex(q => q.id === droppedOnId);

                if (draggedIndex === -1 || droppedOnIndex === -1) {
                    console.error("Fehler: Gezogenes oder Ziel-Element nicht gefunden.");
                    showMessageBox("Fehler beim Verschieben der Quest.");
                    return;
                }

                const [movedQuest] = quests.splice(draggedIndex, 1);
                quests.splice(droppedOnIndex, 0, movedQuest);

                await updateQuestOrderInFirestore();
                showMessageBox('Reihenfolge der Quests aktualisiert!');
            }
        }

        async function handleDragEnd(e) {
            if (!isEditMode) return;
            this.classList.remove('dragging');
            document.querySelectorAll('.quest-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            renderQuestList();
        }

        /**
         * Aktualisiert die 'order'-Eigenschaft aller Quests in Firestore.
         */
        async function updateQuestOrderInFirestore() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Kann Reihenfolge nicht speichern.");
                return;
            }
            showLoading();
            try {
                const batch = writeBatch(db);
                quests.forEach((quest, index) => {
                    const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, quest.id);
                    batch.update(questDocRef, { order: index });
                });
                await batch.commit();
            } catch (e) {
                console.error("Fehler beim Speichern der neuen Quest-Reihenfolge: ", e);
                showMessageBox("Fehler beim Speichern der Reihenfolge: " + e.message);
            } finally {
                hideLoading();
            }
        }

        // Event Listener initialisieren
        // Diese Event-Listener werden dynamisch zugewiesen, wenn der Edit-Modus die Felder rendert.
        // addQuestButton.addEventListener('click', addQuest);
        // saveQuestButton.addEventListener('click', saveQuestChanges);
        // deleteQuestButton.addEventListener('click', deleteQuest);

        messageBoxCloseButton.addEventListener('click', hideMessageBox);
        sortButton.addEventListener('click', sortQuests);

        enterEditModeButton.addEventListener('click', () => {
            if (passwordInput.value === correctPassword) {
                isEditMode = true;
                passwordInput.value = '';
                updateUIForMode();
                if (quests.length > 0) {
                    selectQuest(selectedQuestId || quests[0].id); // Wähle die erste Quest aus, wenn noch keine ausgewählt ist
                } else {
                    clearQuestDetails();
                }
                showMessageBox('Bearbeitungsmodus aktiviert! Du kannst Quests jetzt ziehen und ablegen.');
            } else {
                showMessageBox('Falsches Passwort!');
                passwordInput.value = '';
            }
        });

        closeButton.addEventListener('click', () => {
            isEditMode = false;
            passwordInput.value = '';
            updateUIForMode();
            if (quests.length > 0) {
                const firstSelectable = quests.find(q => q.status === 'aktiv' || q.status === 'abgeschlossen');
                if (firstSelectable) {
                    selectQuest(firstSelectable.id);
                } else {
                    clearQuestDetails();
                }
            } else {
                clearQuestDetails();
            }
            showMessageBox('Das Questlog schließt sich und kehrt in den Ansichtsmodus zurück.');
        });

        document.addEventListener('DOMContentLoaded', initializeFirebaseAndLoadQuests);
    </script>
</body>
</html>
