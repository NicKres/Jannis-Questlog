<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jannis Questlog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=IM+Fell+Double+Pica&display=swap" rel="stylesheet">
    
    <script type="module">
        // Deine Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyChyA0KQQMG0M4SnaHIdxwguJH8dYYDO-w",
            authDomain: "wowquestlogprojekt.firebaseapp.com",
            projectId: "wowquestlogprojekt",
            storageBucket: "wowquestlogprojekt.appspot.com",
            messagingSenderId: "689308532820",
            appId: "1:689308532820:web:0523701ea7c790a8c6adc1"
        };

        // Firebase Module importieren
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Globale Variablen
        let questsData = {};
        let currentSelectedQuestId = null;
        let adminMode = false;
        let db;

        // UI Elemente
        let questListContent, questDetailContent, questCounter, trackQuestBtn;

        // Hauptfunktion
        async function main() {
            questListContent = document.getElementById('quest-list-content');
            questDetailContent = document.getElementById('quest-detail-content');
            questCounter = document.getElementById('quest-counter');
            trackQuestBtn = document.getElementById('track-quest-btn');

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                console.log("Firebase angebunden.");
                setupFirestoreListener();
                setupEventListeners();
            } catch (error) {
                console.error("Firebase Fehler: ", error);
                questListContent.innerHTML = `<div class="quest-category" style="color: #c00;">Verbindung zur Datenbank fehlgeschlagen.</div>`;
            }
        }

        function setupFirestoreListener() {
            const questsCollectionPath = "artifacts/wowquestlogprojekt/public/data/quests";
            onSnapshot(collection(db, questsCollectionPath), (snapshot) => {
                questListContent.innerHTML = ''; // Liste leeren
                const docs = [];
                snapshot.forEach((doc) => docs.push({ id: doc.id, ...doc.data() }));
                
                docs.sort((a, b) => (a.order || 0) - (b.order || 0));

                questsData = {};
                let nonCategoryQuestsCount = 0;
                docs.forEach(quest => {
                    questsData[quest.id] = quest;

                    if (quest.isCategory) {
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'quest-category';
                        categoryItem.innerHTML = `<div class="quest-icon icon-collapse"></div><span>${quest.title}</span>`;
                        questListContent.appendChild(categoryItem);
                    } else {
                        nonCategoryQuestsCount++;
                        const questItem = document.createElement('div');
                        questItem.className = 'quest-item';
                        questItem.dataset.questId = quest.id;
                        questItem.innerHTML = `
                            <span class="quest-title">${quest.title}</span>
                            <span class="quest-status">
                                (${quest.xp || 'JGA'})
                                ${quest.status === 'completed' ? '<div class="quest-icon icon-checkmark"></div>' : ''}
                            </span>
                        `;
                        questListContent.appendChild(questItem);
                    }
                });
                
                if (questCounter) {
                    questCounter.innerText = `Quests: ${nonCategoryQuestsCount}/25`;
                }
                
                const firstQuest = docs.find(q => !q.isCategory);
                if (!currentSelectedQuestId && firstQuest) {
                    showQuestDetails(firstQuest.id);
                } else {
                    showQuestDetails(currentSelectedQuestId);
                }
            }, (error) => {
                console.error("Fehler beim Abrufen der Quests: ", error);
                questListContent.innerHTML = `<div class="quest-category" style="color: #c00;">Quests konnten nicht geladen werden. Prüfe den DB-Pfad und die Sicherheitsregeln.</div>`;
            });
        }
        
        function showQuestDetails(questId) {
             if (!questId || !questsData[questId] || questsData[questId].isCategory) return;
            currentSelectedQuestId = questId;
            const quest = questsData[questId];
            
            if (adminMode) {
                renderAdminView(quest);
            } else {
                renderQuestView(quest);
            }
            
            document.querySelectorAll('.quest-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.quest-item[data-quest-id='${questId}']`);
            if(activeItem) activeItem.classList.add('active');
        }

        function renderQuestView(quest) {
            questDetailContent.innerHTML = `
                <h2>${quest.title}</h2>
                <p class="quest-giver">${quest.giver || 'Ein Abgesandter des Spielmasters hat eine Nachricht für dich.'}</p>
                <p class="quest-objective">${quest.tasks || 'Objective'}</p>
                <h3>DESCRIPTION</h3>
                <p>${quest.description ? quest.description.replace(/\n/g, '<br>') : ''}</p>
                <h3>REWARDS</h3>
                <p>${quest.reward ? quest.reward.replace(/\n/g, '<br>') : ''}</p>
            `;
        }

        function renderAdminView(quest, isNew = false) {
             questDetailContent.innerHTML = `
                <h2>${isNew ? 'Neue Quest erstellen' : 'Quest bearbeiten'}</h2>
                <div class="admin-form">
                    <label>Titel:</label>
                    <input type="text" id="admin-title" value="${quest.title || ''}">
                    <label>Questgeber-Text:</label>
                    <input type="text" id="admin-giver" value="${quest.giver || ''}">
                    <label>Beschreibung:</label>
                    <textarea id="admin-description">${quest.description || ''}</textarea>
                    <label>Aufgaben:</label>
                    <textarea id="admin-tasks">${quest.tasks || ''}</textarea>
                    <label>Belohnung:</label>
                    <input type="text" id="admin-reward" value="${quest.reward || ''}">
                    <label>Zusatz (z.B. JGA):</label>
                    <input type="text" id="admin-xp" value="${quest.xp || ''}">
                    <label>Status:</label>
                    <select id="admin-status">
                        <option value="active" ${quest.status === 'active' ? 'selected' : ''}>Aktiv</option>
                        <option value="completed" ${quest.status === 'completed' ? 'selected' : ''}>Abgeschlossen</option>
                    </select>
                    <label><input type="checkbox" id="admin-is-category" ${quest.isCategory ? 'checked' : ''}> Ist eine Kategorie (Überschrift)?</label>
                    <label>Reihenfolge (Nummer):</label>
                    <input type="number" id="admin-order" value="${quest.order || 0}">
                    <button class="admin-save-button" id="save-quest-btn">${isNew ? 'Erstellen' : 'Speichern'}</button>
                </div>
            `;
            
            const form = questDetailContent.querySelector('.admin-form');
            const newQuestBtn = document.createElement('button');
            newQuestBtn.className = 'admin-new-quest-button';
            newQuestBtn.innerText = 'Neue Quest erstellen';
            newQuestBtn.onclick = () => renderAdminView({}, true);
            form.appendChild(newQuestBtn);

            document.getElementById('save-quest-btn').addEventListener('click', () => saveQuestChanges(quest.id, isNew));
        }
        
        async function saveQuestChanges(questId, isNew) {
            const questsCollectionPath = "artifacts/wowquestlogprojekt/public/data/quests";
            const saveData = {
                title: document.getElementById('admin-title').value,
                giver: document.getElementById('admin-giver').value,
                description: document.getElementById('admin-description').value,
                tasks: document.getElementById('admin-tasks').value,
                reward: document.getElementById('admin-reward').value,
                xp: document.getElementById('admin-xp').value,
                status: document.getElementById('admin-status').value,
                isCategory: document.getElementById('admin-is-category').checked,
                order: parseInt(document.getElementById('admin-order').value, 10) || 0,
            };

            try {
                if (isNew) {
                    await addDoc(collection(db, questsCollectionPath), saveData);
                } else {
                    const questRef = doc(db, questsCollectionPath, questId);
                    await updateDoc(questRef, saveData);
                }
                adminMode = false;
                if (trackQuestBtn) trackQuestBtn.classList.remove('active');
            } catch (e) {
                console.error("Fehler beim Speichern: ", e);
                alert("Speichern fehlgeschlagen!");
            }
        }

        function setupEventListeners() {
            questListContent.addEventListener('click', (event) => {
                const questItem = event.target.closest('.quest-item');
                if (questItem) showQuestDetails(questItem.dataset.questId);
            });

            document.getElementById('abandon-btn').addEventListener('click', () => {
                const quotes = [
                    "Arise, my champion!", "You are not prepared!", "Tempest Keep was merely a setback.",
                    "By fire be purged!", "LEEROOOY JENKINS!", "Work is da poop! No more!",
                    "You no take candle!", "Me not that kind of orc.", "Stand in the fire, DPS is higher.",
                    "Less QQ, more pew pew.", "Did you think we had forgotten? Did you think we had forgiven?",
                    "Time is money, friend.", "Lok'tar ogar! Victory or death!",
                ];
                document.getElementById('modal-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
                document.getElementById('quote-modal').style.display = 'flex';
            });

            if (trackQuestBtn) {
                trackQuestBtn.addEventListener('click', () => {
                    if (adminMode) {
                        adminMode = false;
                        trackQuestBtn.classList.remove('active');
                        showQuestDetails(currentSelectedQuestId);
                        return;
                    }
                    const password = prompt("Spielmaster-Passwort:");
                    if (password === 'HomoComo') {
                        adminMode = true;
                        trackQuestBtn.classList.add('active');
                        if (currentSelectedQuestId) {
                            showQuestDetails(currentSelectedQuestId);
                        } else {
                            renderAdminView({}, true);
                        }
                    } else if (password) {
                        alert('Falsches Passwort!');
                    }
                });
            }
            
            document.querySelector('.modal-close-btn').addEventListener('click', () => {
                document.getElementById('quote-modal').style.display = 'none';
            })
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
    
    <style>
        :root {
            --font-title: 'Cinzel Decorative', serif;
            --font-text: 'IM Fell Double Pica', serif;
            --color-gold: #ffd100;
            --color-text-light: #f0d890;
            --color-text-dark: #222;
            --color-quest-active: #fff;
            --color-quest-completed: #888;
            
            --questlog-background: url('assets/questlog_background.png');
            --icon-checkmark: url('assets/icon_checkmark.png');
            --icon-collapse: url('assets/icon_collapse.png');
            --messagebox-background: url('assets/messagebox.png');
        }
        body {
            background-color: #1a1a1a;
            font-family: var(--font-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .questlog-container {
            width: 1024px;
            max-width: 100%;
            height: 700px;
            background-image: var(--questlog-background);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            color: var(--color-text-light);
        }
        
        #quest-counter {
            position: absolute;
            top: 4.5%;
            right: 12%;
            font-family: var(--font-title);
            font-size: 14px;
        }
        #track-quest-btn {
            position: absolute;
            top: 14.2%;
            left: 11.5%;
            font-size: 14px;
            cursor: pointer;
            color: var(--color-quest-completed);
        }
        #track-quest-btn.active { color: var(--color-quest-active); }
        
        .questlog-main {
            display: flex;
            position: absolute;
            top: 10.5%;
            bottom: 10.5%;
            left: 3.5%;
            right: 3.5%;
            gap: 2.5%;
        }
        .quest-list-panel {
            width: 44%;
            overflow-y: auto;
            padding-right: 15px;
            margin-top: 55px;
        }
        .quest-detail-panel {
            width: 53.5%;
            overflow-y: auto;
            padding: 10px 20px 10px 10px;
            font-size: 14px;
            line-height: 1.6;
        }
        .quest-category {
            display: flex;
            align-items: center;
            font-family: var(--font-title);
            color: var(--color-gold);
            font-size: 15px;
            margin: 15px 0 5px 0;
        }
        .quest-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            margin-left: 20px;
        }
        .quest-item.active { background-color: rgba(255, 255, 255, 0.15); }
        .quest-title { color: var(--color-quest-active); }
        .quest-status { display: flex; align-items: center; color: var(--color-quest-completed); }
        
        .quest-detail-panel h2 {
            font-family: var(--font-title); font-size: 18px; color: #000; margin-top: 0;
        }
        .quest-detail-panel h3 {
            font-family: var(--font-title); font-size: 14px; color: #000; margin-top: 20px;
        }
        .quest-detail-panel p { color: var(--color-text-dark); }
        .quest-giver, .quest-objective { color: #50280a; font-weight: bold; }

        .questlog-button {
            position: absolute;
            bottom: 3.2%;
            border: none;
            background: transparent;
            cursor: pointer;
            width: 130px;
            height: 35px;
            color: transparent; /* Macht den Text unsichtbar */
        }
        #abandon-btn { left: 4.5%; }
        
        .quest-icon {
            width: 16px; height: 16px; background-size: contain; background-repeat: no-repeat;
        }
        .icon-collapse { background-image: var(--icon-collapse); margin-right: 8px;}
        .icon-checkmark { background-image: var(--icon-checkmark); margin-left: 8px; }
        
        .admin-form { color: #000; max-height: 450px; overflow-y: auto; padding: 5px; }
        .admin-form label { display: block; margin-top: 10px; font-weight: bold; }
        .admin-form input, .admin-form textarea, .admin-form select {
            width: 100%; padding: 8px; font-size: 14px; border: 1px solid #887a61; box-sizing: border-box;
            border-radius: 3px;
        }
        .admin-form textarea { resize: vertical; min-height: 80px; }
        .admin-save-button, .admin-new-quest-button {
            display: block; margin: 20px auto 0; padding: 10px 25px;
            font-family: var(--font-title); color: var(--color-gold);
            background-color: #3a2a1a; border: 1px solid var(--color-gold);
            border-radius: 5px; cursor: pointer;
        }

        ::-webkit-scrollbar { width: 16px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #524033; border: 1px solid #2c1e14; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #715845; }

        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-image: var(--messagebox-background);
            background-size: 100% 100%;
            width: 600px;
            height: 150px;
            padding: 20px 20px 20px 120px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #modal-quote {
            font-size: 16px; color: var(--color-text-light);
            text-shadow: 1px 1px 2px #000;
            margin: 0;
        }
        .modal-close-btn {
            align-self: flex-end;
            margin-top: 10px; padding: 5px 15px;
            font-family: var(--font-title); cursor: pointer;
            color: var(--color-gold); background-color: #3a2a1a;
            border: 1px solid var(--color-gold);
        }

        @media (max-width: 1024px) {
            .questlog-container {
                width: 100%;
                height: 0;
                padding-bottom: 68.36%; /* Aspect ratio 700/1024 */
            }
        }

    </style>
</head>
<body>
    <div class="questlog-container">
        <header>
            <div id="track-quest-btn">Track Quest</div>
            <div id="quest-counter">Quests: 0/25</div>
        </header>

        <main class="questlog-main">
            <div class="quest-list-panel">
                <div id="quest-list-content">
                    <div class="quest-category">Lade Quests...</div>
                </div>
            </div>
            <div class="quest-detail-panel" id="quest-detail-content"></div>
        </main>

        <footer>
            <button class="questlog-button" id="abandon-btn"></button>
        </footer>
    </div>

    <div id="quote-modal" class="modal">
        <div class="modal-content">
            <p id="modal-quote">Hier kommt ein Spruch hin.</p>
            <button class="modal-close-btn">Schließen</button>
        </div>
    </div>

</body>
</html>
