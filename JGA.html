<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Questlog</title>
    <!-- Tailwind CSS CDN für schnelle Styling-Grundlagen -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts für einen Fantasy-Look -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <style>
        /* Grundlegende Stile für den Body */
        body {
            background-color: #2b2a2a; /* Dunkler Hintergrund */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            font-family: 'IM Fell English SC', serif; /* Standard-Textschrift */
            color: #ccc;
        }

        /* Angepasste Scrollbar für Firefox */
        .custom-scrollbar::-moz-scrollbar {
            width: 12px;
        }
        .custom-scrollbar::-moz-scrollbar-track {
            background: #4a3b2a; /* Dunkelbraun */
            border-radius: 6px;
        }
        .custom-scrollbar::-moz-scrollbar-thumb {
            background: #8b6d4a; /* Goldbraun */
            border-radius: 6px;
            border: 1px solid #5a4b3a;
        }

        /* Angepasste Scrollbar für Webkit (Chrome, Safari, Edge) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #4a3b2a; /* Dunkelbraun */
            border-radius: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #8b6d4a; /* Goldbraun */
            border-radius: 6px;
            border: 1px solid #5a4b3a;
        }

        /* Stil für das Hauptfenster des Questlogs */
        .questlog-window {
            background-color: #1a1a1a; /* Sehr dunkler Hintergrund für den Innenbereich */
            border: 6px solid #4a3b2a; /* Hauptrahmen in Dunkelbraun */
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.8),
                        0 0 0 2px #6a5b4a; /* Zusätzlicher goldener Schatten für den Rahmeneffekt */
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Sicherstellen, dass nichts überläuft */
            position: relative;
            min-height: 600px; /* Mindesthöhe für das Fenster */
        }

        /* Stil für den Header-Bereich */
        .questlog-header {
            background: linear-gradient(to bottom, #5a4b3a, #3a2b1a); /* Goldbrauner Farbverlauf */
            border-bottom: 2px solid #2a1b0a;
            padding: 12px 20px;
            text-align: center;
            position: relative;
        }

        .header-title {
            font-family: 'Cinzel Decorative', serif; /* Spezielle Schrift für den Titel */
            font-size: 2.2rem; /* Große Schriftgröße */
            color: gold;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.7);
            letter-spacing: 2px;
        }

        /* Stil für den Schließen-Button im Header */
        .close-button {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #8b0000; /* Dunkelrot */
            color: white;
            border: 2px solid #d4af37; /* Goldener Rand */
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .close-button:hover {
            background-color: #a00000;
            border-color: #ffe08c;
        }

        /* Hauptinhaltsbereich mit zwei Spalten */
        .questlog-content {
            display: flex;
            flex-grow: 1; /* Nimmt den verbleibenden Platz ein */
            background-color: #1e1e1e; /* Hintergrund für den Inhaltsbereich */
        }

        /* Linke Spalte: Questliste */
        .questlist-panel {
            width: 35%; /* Breite der Questlisten-Spalte */
            background-color: #2a2a2a; /* Dunklerer Hintergrund für die Liste */
            border-right: 2px solid #4a3b2a; /* Trennlinie */
            padding: 15px;
            overflow-y: auto; /* Scrollbar bei Überlauf */
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 250px; /* Mindestbreite für die Liste */
        }

        /* Stil für einzelne Quest-Items in der Liste */
        .quest-item {
            background-color: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .quest-item:hover {
            background-color: #4a4a4a;
            border-color: #6a6a6a;
        }

        .quest-item.selected {
            background-color: #5a4b3a; /* Ausgewählte Quest in Goldbraun */
            border-color: gold;
            box-shadow: 0 0 5px gold, inset 0 0 5px rgba(255, 215, 0, 0.6);
        }

        .quest-item.dimmed-quest {
            opacity: 0.6;
            cursor: default;
            pointer-events: none; /* Macht es nicht klickbar */
        }

        .quest-item-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.1rem;
            color: gold;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
        }

        .quest-item-status {
            font-size: 0.85rem;
            color: #a0a0a0;
        }

        /* Rechte Spalte: Quest-Details */
        .quest-details-panel {
            flex-grow: 1; /* Nimmt den restlichen Platz ein */
            padding: 20px;
            overflow-y: auto; /* Scrollbar bei Überlauf */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .details-title {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.8rem;
            color: gold;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid #4a3b2a;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Stile für Textareas und Input-Felder */
        .editable-field {
            background-color: #111; /* Sehr dunkler Hintergrund */
            border: 1px solid #4a3b2a;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.95rem;
            color: #eee;
            width: 100%;
            box-sizing: border-box; /* Padding und Border werden in die Breite eingerechnet */
            resize: vertical; /* Nur vertikal anpassbar */
            font-family: 'IM Fell English SC', serif;
        }

        .editable-field:focus {
            outline: none;
            border-color: gold;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        /* Buttons im unteren Bereich */
        .button-group {
            display: flex;
            justify-content: flex-end; /* Buttons rechtsbündig */
            gap: 10px;
            margin-top: auto; /* Buttons am unteren Rand des Panels */
            padding-top: 20px;
            border-top: 1px solid #4a3b2a;
        }

        .action-button {
            background: linear-gradient(to bottom, #8b6d4a, #5a4b3a); /* Goldbrauner Button */
            color: white;
            border: 2px solid #d4af37; /* Goldener Rand */
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.6);
            transition: background 0.2s ease, transform 0.1s ease;
            font-family: 'Cinzel Decorative', serif;
            letter-spacing: 1px;
        }

        .action-button:hover {
            background: linear-gradient(to bottom, #a0815e, #6a5b4a);
            transform: translateY(-2px);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
        }

        /* Spezielle Farbe für den Löschen-Button */
        .delete-button {
            background: linear-gradient(to bottom, #a00000, #8b0000); /* Rotton */
            border-color: #ff4d4d;
        }

        .delete-button:hover {
            background: linear-gradient(to bottom, #c00000, #a00000);
            border-color: #ff6666;
        }

        /* Meldungsbox-Stil */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            border: 3px solid gold;
            border-radius: 10px;
            padding: 25px 35px;
            color: white;
            font-family: 'IM Fell English SC', serif;
            font-size: 1.2rem;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            max-width: 400px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        .message-box button {
            background: linear-gradient(to bottom, #8b6d4a, #5a4b3a);
            color: white;
            border: 2px solid gold;
            border-radius: 5px;
            padding: 8px 15px;
            margin-top: 15px;
            cursor: pointer;
            font-family: 'Cinzel Decorative', serif;
            font-size: 1rem;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .message-box button:hover {
            background: linear-gradient(to bottom, #a0815e, #6a5b4a);
            transform: translateY(-1px);
        }

        /* Neue Stile für den Ansichtsmodus (Read-only) */
        .read-only-text {
            background-image: url('https://placehold.co/400x200/f8f0e3/4a3b2a?text=Parchment'); /* Beispiel Pergament-Hintergrund */
            background-size: cover;
            background-color: #f8f0e3; /* Hellbeige für Pergament-Effekt */
            color: #4a3b2a; /* Dunkelbraune Schrift auf Pergament */
            border: 1px solid #7a6b5a;
            border-radius: 5px;
            padding: 10px;
            font-family: 'IM Fell English SC', serif;
            font-size: 1rem; /* Slightly larger font size for readability */
            line-height: 1.5;
            white-space: pre-wrap; /* Behält Zeilenumbrüche bei */
            overflow: hidden; /* Für den Schreibeffekt */
        }

        .read-only-text.typing-effect {
            /* Dies wird von JavaScript animiert */
        }

        /* Footer style */
        .questlog-footer {
            background-color: #3a2b1a; /* Darker brown, subtle */
            border-top: 2px solid #2a1b0a;
            padding: 8px 20px;
            text-align: center;
            display: flex;
            justify-content: flex-end; /* Align to end */
            align-items: center;
            position: relative;
            z-index: 10; /* Ensure it's above content */
        }

        .password-panel {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.4); /* Semi-transparent background */
            border-radius: 8px;
            border: 1px solid #5a4b3a; /* Subtle border */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .password-panel.hidden {
            opacity: 0;
            pointer-events: none; /* Make it unclickable when hidden */
            transform: translateY(10px); /* Slide down slightly */
        }
        .password-input {
            background-color: #1a1a1a;
            border: 1px solid #4a3b2a;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 0.85rem;
            color: #eee;
            width: 120px; /* Smaller width for input */
        }
        .action-button-small { /* Smaller version of action-button */
            background: linear-gradient(to bottom, #8b6d4a, #5a4b3a);
            color: white;
            border: 1px solid #d4af37;
            border-radius: 5px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            transition: background 0.2s ease, transform 0.1s ease;
            font-family: 'Cinzel Decorative', serif;
        }
        .action-button-small:hover {
            background: linear-gradient(to bottom, #a0815e, #6a5b4a);
            transform: translateY(-1px);
        }
        .action-button-small:active {
            transform: translateY(0);
            box-shadow: 0.5px 0.5px 2px rgba(0, 0, 0, 0.5);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: gold;
            font-size: 1.5rem;
            z-index: 999;
            flex-direction: column;
            gap: 10px;
        }
        .spinner {
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid gold;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        @media (max-width: 768px) {
            .questlog-content {
                flex-direction: column; /* Vertikales Layout auf kleineren Bildschirmen */
            }

            .questlist-panel {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #4a3b2a;
                min-height: 200px; /* Mindesthöhe für die Liste auf Mobilgeräten */
                max-height: 40vh; /* Max Höhe für scrollbare Liste auf Mobilgeräten */
            }

            .quest-details-panel {
                padding: 15px;
            }

            .details-title {
                font-size: 1.5rem;
            }

            .header-title {
                font-size: 1.8rem;
            }

            .button-group {
                flex-direction: column; /* Buttons untereinander auf kleinen Bildschirmen */
                align-items: stretch;
            }
            .password-panel {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="questlog-window">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
            <p>Lade Quests...</p>
        </div>

        <!-- Header-Bereich des Questlogs -->
        <div class="questlog-header">
            <span class="header-title">Questlog</span>
            <button class="close-button" id="closeButton">X</button>
        </div>

        <!-- Sortierungsoptionen (Nur sichtbar im Bearbeitungsmodus) -->
        <div id="sortPanel" class="p-4 bg-gray-700 border-b border-gray-600 flex flex-wrap justify-end items-center gap-4 hidden">
            <label for="sortCriteria" class="text-gold-300">Sortieren nach:</label>
            <select id="sortCriteria" class="editable-field w-auto min-w-[150px]">
                <option value="titleAsc">Titel (A-Z)</option>
                <option value="titleDesc">Titel (Z-A)</option>
                <option value="status">Status</option>
            </select>
            <button id="sortButton" class="action-button">Sortieren</button>
        </div>

        <!-- Hauptinhaltsbereich: Questliste und Details -->
        <div class="questlog-content custom-scrollbar">
            <!-- Linke Spalte: Questliste -->
            <div class="questlist-panel custom-scrollbar" id="questListPanel">
                <!-- Quests werden hier dynamisch eingefügt -->
            </div>

            <!-- Rechte Spalte: Quest-Details und Bearbeitungsbereich -->
            <div class="quest-details-panel custom-scrollbar" id="questDetailsPanel">

                <!-- Elemente für den Bearbeitungsmodus -->
                <div id="editModeFields" class="flex flex-col gap-4 hidden">
                    <h3 class="details-title" id="detailsTitleEditMode">Wähle eine Quest</h3>

                    <input type="text" id="questTitleInput" class="editable-field" placeholder="Quest Titel">

                    <textarea id="questDescriptionTextarea" class="editable-field" rows="6" placeholder="Beschreibung"></textarea>

                    <textarea id="questObjectivesTextarea" class="editable-field" rows="4" placeholder="Ziele (eine pro Zeile)"></textarea>

                    <input type="text" id="questRewardInput" class="editable-field" placeholder="Belohnung für die Quest">

                    <select id="questStatusSelect" class="editable-field">
                        <option value="Aktiv">Aktiv</option>
                        <option value="Abgeschlossen">Abgeschlossen</option>
                        <option value="Fehlgeschlagen">Fehlgeschlagen</option>
                        <option value="Folgequest">Folgequest</option> <!-- Neuer Status -->
                    </select>

                    <!-- Buttons für Aktionen im Bearbeitungsmodus -->
                    <div class="button-group">
                        <button class="action-button" id="addQuestButton">Neue Quest</button>
                        <button class="action-button" id="saveQuestButton">Änderungen speichern</button>
                        <button class="action-button delete-button" id="deleteQuestButton">Quest löschen</button>
                    </div>
                </div>

                <!-- Elemente für den Ansichtsmodus (Read-only) -->
                <div id="readOnlyFields" class="flex flex-col gap-4">
                    <h3 class="details-title" id="detailsTitleReadOnly">Wähle eine Quest</h3>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Beschreibung:</p>
                        <p id="roDescription" class="read-only-text"></p>
                    </div>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Ziele:</p>
                        <div id="roObjectivesContainer" class="read-only-text"></div> <!-- Geändert von ul zu div -->
                    </div>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Belohnung:</p>
                        <p id="roReward" class="read-only-text"></p>
                    </div>
                    <div class="read-only-section">
                        <p class="font-bold text-lg text-gold-200">Status:</p>
                        <p id="roStatus" class="read-only-text"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer für den Login-Bereich und User ID -->
        <div id="questlogFooter" class="questlog-footer">
            <div id="userIdDisplay" class="text-sm text-gray-400 mr-auto">User ID: Lade...</div>
            <div id="passwordPanel" class="password-panel">
                <label for="passwordInput" class="text-gold-300 text-sm font-bold">Passwort für Bearbeitung:</label>
                <input type="password" id="passwordInput" class="password-input" placeholder="Passwort">
                <button id="enterEditModeButton" class="action-button-small">Login</button>
            </div>
        </div>
    </div>

    <!-- Meldungsbox für Bestätigungen/Fehler -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button id="messageBoxCloseButton">OK</button>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM-Elemente abrufen
        const questListPanel = document.getElementById('questListPanel');
        const questDetailsPanel = document.getElementById('questDetailsPanel');

        // Edit Mode Elemente
        const detailsTitleEditMode = document.getElementById('detailsTitleEditMode');
        const questTitleInput = document.getElementById('questTitleInput');
        const questDescriptionTextarea = document.getElementById('questDescriptionTextarea');
        const questObjectivesTextarea = document.getElementById('questObjectivesTextarea');
        const questRewardInput = document.getElementById('questRewardInput');
        const questStatusSelect = document.getElementById('questStatusSelect');
        const addQuestButton = document.getElementById('addQuestButton');
        const saveQuestButton = document.getElementById('saveQuestButton');
        const deleteQuestButton = document.getElementById('deleteQuestButton');
        const editModeFields = document.getElementById('editModeFields');

        // Read-only Mode Elemente
        const detailsTitleReadOnly = document.getElementById('detailsTitleReadOnly');
        const roDescription = document.getElementById('roDescription');
        const roObjectivesContainer = document.getElementById('roObjectivesContainer');
        const roReward = document.getElementById('roReward');
        const roStatus = document.getElementById('roStatus');
        const readOnlyFields = document.getElementById('readOnlyFields');

        // Passwort und Modus-Steuerung
        const passwordInput = document.getElementById('passwordInput');
        const enterEditModeButton = document.getElementById('enterEditModeButton');
        const passwordPanel = document.getElementById('passwordPanel');
        const correctPassword = 'HomoComo'; // Das festgelegte Passwort

        // Sortierungs-Elemente
        const sortCriteriaSelect = document.getElementById('sortCriteria');
        const sortButton = document.getElementById('sortButton');
        const sortPanel = document.getElementById('sortPanel');

        // Allgemeine Elemente
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');
        const closeButton = document.getElementById('closeButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let quests = []; // Array zum Speichern der Quest-Daten
        let selectedQuestId = null; // ID der aktuell ausgewählten Quest
        let isEditMode = false; // Steuert den Modus (Bearbeiten vs. Nur-Ansicht)
        let typingTimeout; // Für den Schreibeffekt

        // Firebase Initialisierung
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let questCollectionRef;
        let isFirebaseReady = false; // Flag to indicate Firebase is ready

        /**
         * Zeigt eine Ladeanzeige an.
         */
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        /**
         * Verbirgt die Ladeanzeige.
         */
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        /**
         * Zeigt eine Meldungsbox mit einer Nachricht an.
         * @param {string} message - Die anzuzeigende Nachricht.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.add('show');
        }

        /**
         * Verbirgt die Meldungsbox.
         */
        function hideMessageBox() {
            messageBox.classList.remove('show');
        }

        /**
         * Initialisiert Firebase und lädt Quests.
         */
        async function initializeFirebaseAndLoadQuests() {
            showLoading();
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Firestore-Sammlung für öffentliche Quests
                questCollectionRef = collection(db, `artifacts/${appId}/public/data/quests`);

                // Authentifizierung
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `User ID: ${currentUserId}`;
                        isFirebaseReady = true;
                        loadQuestsFromFirestore(); // Quests laden, sobald authentifiziert
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessageBox("Fehler bei der Authentifizierung: " + error.message);
                            hideLoading();
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessageBox("Fehler beim Initialisieren von Firebase: " + error.message);
                hideLoading();
            }
        }

        /**
         * Lädt Quests von Firestore.
         */
        function loadQuestsFromFirestore() {
            if (!isFirebaseReady) return;

            onSnapshot(questCollectionRef, (snapshot) => {
                const fetchedQuests = [];
                snapshot.forEach(doc => {
                    fetchedQuests.push({ id: doc.id, ...doc.data() });
                });
                quests = fetchedQuests; // Quests-Array aktualisieren
                updateUIForMode(); // UI-Modus aktualisieren
                renderQuestList(); // Liste neu rendern

                // Initial- oder ausgewählte Quest im Detailbereich anzeigen
                if (quests.length > 0) {
                    const previouslySelected = quests.find(q => q.id === selectedQuestId);
                    const initialSelectableQuest = isEditMode
                        ? (previouslySelected || quests[0])
                        : (previouslySelected || quests.find(q => q.status === 'Aktiv' || q.status === 'Abgeschlossen'));

                    if (initialSelectableQuest) {
                        selectQuest(initialSelectableQuest.id);
                    } else {
                        clearQuestDetails();
                        detailsTitleReadOnly.textContent = 'Keine sichtbaren Quests zum Anzeigen.';
                        detailsTitleEditMode.textContent = 'Füge eine neue Quest hinzu oder mache eine aktiv!';
                    }
                } else {
                    clearQuestDetails();
                    detailsTitleReadOnly.textContent = 'Keine Quests zum Anzeigen.';
                    detailsTitleEditMode.textContent = 'Füge eine neue Quest hinzu!';
                }
                hideLoading();
            }, (error) => {
                console.error("Fehler beim Laden der Quests von Firestore:", error);
                showMessageBox("Fehler beim Laden der Quests: " + error.message);
                hideLoading();
            });
        }

        /**
         * Aktualisiert die Sichtbarkeit der UI-Elemente basierend auf dem aktuellen Modus.
         */
        function updateUIForMode() {
            if (isEditMode) {
                editModeFields.classList.remove('hidden');
                readOnlyFields.classList.add('hidden');
                sortPanel.classList.remove('hidden'); // Sortieroptionen im Bearbeitungsmodus sichtbar
                passwordPanel.classList.add('hidden'); // Passwort-Panel ausblenden
            } else {
                editModeFields.classList.add('hidden');
                readOnlyFields.classList.remove('hidden');
                sortPanel.classList.add('hidden'); // Sortieroptionen im Ansichtsmodus verstecken
                passwordPanel.classList.remove('hidden'); // Passwort-Panel einblenden
            }
            // Stelle sicher, dass die Buttons nur im Edit-Modus aktiv sind, wenn eine Quest ausgewählt ist
            const selected = selectedQuestId !== null;
            saveQuestButton.disabled = !isEditMode || !selected;
            deleteQuestButton.disabled = !isEditMode || !selected;
            addQuestButton.disabled = !isEditMode;
        }


        /**
         * Rendert die Liste der Quests im linken Panel.
         */
        function renderQuestList() {
            questListPanel.innerHTML = ''; // Vorherige Liste leeren
            if (quests.length === 0) {
                const noQuestsMsg = document.createElement('p');
                noQuestsMsg.className = 'text-center text-gray-500 italic mt-4';
                noQuestsMsg.textContent = 'Keine Quests vorhanden. Füge eine neue hinzu!';
                questListPanel.appendChild(noQuestsMsg);
                clearQuestDetails(); // Auch Details leeren, wenn keine Quests
                return;
            }

            quests.forEach(quest => {
                const questItem = document.createElement('div');
                let itemClasses = `quest-item ${quest.id === selectedQuestId ? 'selected' : ''}`;

                // Im Ansichtsmodus "Folgequests" abblenden und nicht klickbar machen
                if (!isEditMode && quest.status === 'Folgequest') {
                    itemClasses += ' dimmed-quest'; // Klasse für visuellen Effekt
                }

                questItem.className = itemClasses;
                questItem.setAttribute('data-id', quest.id);

                questItem.innerHTML = `
                    <div class="quest-item-title">${quest.title}</div>
                    <div class="quest-item-status">Status: ${quest.status}</div>
                `;

                // Event Listener nur hinzufügen, wenn im Bearbeitungsmodus ODER wenn keine "Folgequest" im Ansichtsmodus
                if (isEditMode || (quest.status !== 'Folgequest' && quest.status !== 'Ausgeblendet')) {
                    questItem.addEventListener('click', () => selectQuest(quest.id));
                }

                questListPanel.appendChild(questItem);
            });
        }

        /**
         * Implementiert einen Schreibeffekt für einen Text.
         * @param {HTMLElement} element - Das HTML-Element, in das der Text geschrieben werden soll.
         * @param {string} text - Der vollständige Text, der geschrieben werden soll.
         * @param {number} delay - Verzögerung zwischen den Zeichen in ms.
         * @returns {Promise<void>} - Ein Promise, das erfüllt wird, wenn der Schreibeffekt abgeschlossen ist.
         */
        function typeText(element, text, delay = 30) { // Reduced delay for faster typing
            return new Promise(resolve => {
                if (typingTimeout) clearTimeout(typingTimeout); // Vorherigen Timeout löschen
                element.textContent = ''; // Element leeren
                let i = 0;
                function type() {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                        typingTimeout = setTimeout(type, delay);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

        /**
         * Wählt eine Quest aus und zeigt ihre Details an.
         * Handhabt sowohl den Bearbeitungs- als auch den Ansichtsmodus.
         * @param {string} id - Die ID der ausgewählten Quest.
         */
        function selectQuest(id) {
            selectedQuestId = id;
            const quest = quests.find(q => q.id === id);

            if (!quest) {
                clearQuestDetails();
                return;
            }

            // Im Ansichtsmodus: Wenn es eine "Folgequest" ist, nicht die Details anzeigen
            if (!isEditMode && quest.status === 'Folgequest') {
                clearQuestDetails();
                showMessageBox('Diese Quest ist noch nicht aktiv. Du kannst nur den Titel sehen.');
                selectedQuestId = null; // Verhindert die visuelle Auswahl in der Liste
                renderQuestList(); // Liste neu rendern, um Auswahl aufzuheben
                return;
            }

            if (isEditMode) {
                detailsTitleEditMode.textContent = quest.title;
                questTitleInput.value = quest.title;
                questDescriptionTextarea.value = quest.description;
                questObjectivesTextarea.value = Array.isArray(quest.objectives) ? quest.objectives.join('\n') : '';
                questRewardInput.value = quest.reward;
                questStatusSelect.value = quest.status;
            } else { // Read-only mode
                detailsTitleReadOnly.textContent = quest.title; // Titel im Ansichtsmodus
                roObjectivesContainer.innerHTML = ''; // Vorherige Ziele leeren

                // Schreibeffekt für Beschreibung, Ziele und Belohnung nacheinander
                typeText(roDescription, quest.description)
                    .then(() => {
                        const objectivesText = quest.objectives.map(obj => `• ${obj}`).join('\n'); // Format als Aufzählung
                        return typeText(roObjectivesContainer, objectivesText); // Für Ziele
                    })
                    .then(() => typeText(roReward, quest.reward)) // Für Belohnung
                    .then(() => typeText(roStatus, quest.status)); // Für Status
            }
            renderQuestList(); // Liste aktualisieren, um Auswahl hervorzuheben
            updateUIForMode(); // UI-Elemente basierend auf dem Modus aktualisieren
        }


        /**
         * Leert die Detailansicht.
         */
        function clearQuestDetails() {
            // Beende laufenden Schreibeffekt
            if (typingTimeout) clearTimeout(typingTimeout);

            selectedQuestId = null;
            if (isEditMode) {
                detailsTitleEditMode.textContent = 'Wähle eine Quest';
                questTitleInput.value = '';
                questDescriptionTextarea.value = '';
                questObjectivesTextarea.value = '';
                questRewardInput.value = '';
                questStatusSelect.value = 'Aktiv';
            } else { // Read-only mode
                detailsTitleReadOnly.textContent = 'Wähle eine Quest';
                roDescription.textContent = '';
                roObjectivesContainer.innerHTML = '';
                roReward.textContent = '';
                roStatus.textContent = '';
            }
            updateUIForMode();
            renderQuestList();
        }

        /**
         * Fügt eine neue leere Quest hinzu (in Firestore).
         */
        async function addQuest() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Bitte warten Sie.");
                return;
            }
            showLoading();
            try {
                const newQuest = {
                    title: 'Neue Quest',
                    description: 'Dies ist eine brandneue Quest. Bearbeite die Details!',
                    objectives: ['Erstes Ziel (0/1)'],
                    reward: 'Unbekannt',
                    status: 'Aktiv',
                    createdAt: new Date().toISOString() // Timestamp hinzufügen
                };
                const docRef = await addDoc(questCollectionRef, newQuest);
                selectQuest(docRef.id); // Neue Quest direkt auswählen
                showMessageBox('Neue Quest hinzugefügt!');
            } catch (e) {
                console.error("Fehler beim Hinzufügen der Quest: ", e);
                showMessageBox("Fehler beim Hinzufügen der Quest: " + e.message);
            } finally {
                hideLoading();
            }
        }

        /**
         * Speichert die Änderungen an der aktuell ausgewählten Quest (in Firestore).
         */
        async function saveQuestChanges() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Bitte warten Sie.");
                return;
            }
            if (!selectedQuestId) {
                showMessageBox('Bitte wähle eine Quest zum Speichern aus.');
                return;
            }

            showLoading();
            try {
                const updatedQuest = {
                    title: questTitleInput.value,
                    description: questDescriptionTextarea.value,
                    objectives: questObjectivesTextarea.value.split('\n').filter(line => line.trim() !== ''),
                    reward: questRewardInput.value,
                    status: questStatusSelect.value,
                    updatedAt: new Date().toISOString() // Timestamp aktualisieren
                };
                await setDoc(doc(db, `artifacts/${appId}/public/data/quests`, selectedQuestId), updatedQuest, { merge: true });
                showMessageBox('Änderungen gespeichert!');
            } catch (e) {
                console.error("Fehler beim Speichern der Änderungen: ", e);
                showMessageBox("Fehler beim Speichern der Änderungen: " + e.message);
            } finally {
                hideLoading();
            }
        }

        /**
         * Löscht die aktuell ausgewählte Quest (in Firestore).
         */
        async function deleteQuest() {
            if (!isFirebaseReady) {
                showMessageBox("Firebase ist nicht bereit. Bitte warten Sie.");
                return;
            }
            if (!selectedQuestId) {
                showMessageBox('Bitte wähle eine Quest zum Löschen aus.');
                return;
            }

            // Zeige Bestätigungsbox
            showMessageBox('Soll diese Quest wirklich gelöscht werden?');
            messageBoxCloseButton.textContent = 'Ja'; // Text ändern für Ja/Nein
            const originalCloseHandler = messageBoxCloseButton.onclick; // Handler sichern
            messageBoxCloseButton.onclick = async () => {
                showLoading();
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/quests`, selectedQuestId));
                    clearQuestDetails(); // Detailansicht leeren
                    showMessageBox('Quest gelöscht!');
                } catch (e) {
                    console.error("Fehler beim Löschen der Quest: ", e);
                    showMessageBox("Fehler beim Löschen der Quest: " + e.message);
                } finally {
                    hideLoading();
                    messageBoxCloseButton.textContent = 'OK'; // Reset Text
                    messageBoxCloseButton.onclick = originalCloseHandler; // Reset Handler
                }
                hideMessageBox();
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Nein';
            cancelButton.className = 'action-button delete-button ml-2';
            cancelButton.onclick = () => {
                hideMessageBox();
                messageBoxCloseButton.textContent = 'OK'; // Reset Text
                messageBoxCloseButton.onclick = originalCloseHandler; // Reset Handler
                cancelButton.remove(); // Entferne den Nein-Button
            };
            messageBox.appendChild(cancelButton); // Füge Nein-Button hinzu
        }

        /**
         * Sortiert die Quests basierend auf dem ausgewählten Kriterium (in memory).
         */
        function sortQuests() {
            const criteria = sortCriteriaSelect.value;
            if (criteria === 'titleAsc') {
                quests.sort((a, b) => a.title.localeCompare(b.title));
            } else if (criteria === 'titleDesc') {
                quests.sort((a, b) => b.title.localeCompare(a.title));
            } else if (criteria === 'status') {
                const statusOrder = { 'Aktiv': 1, 'Fehlgeschlagen': 2, 'Folgequest': 3, 'Abgeschlossen': 4 }; // Priorität
                quests.sort((a, b) => {
                    const statusA = statusOrder[a.status] || 99;
                    const statusB = statusOrder[b.status] || 99;
                    if (statusA === statusB) {
                        return a.title.localeCompare(b.title); // Sekundäre Sortierung nach Titel
                    }
                    return statusA - statusB;
                });
            }
            renderQuestList();
            showMessageBox('Quests sortiert!');
        }


        // Event Listener initialisieren
        addQuestButton.addEventListener('click', addQuest);
        saveQuestButton.addEventListener('click', saveQuestChanges);
        deleteQuestButton.addEventListener('click', deleteQuest);
        messageBoxCloseButton.addEventListener('click', hideMessageBox);
        sortButton.addEventListener('click', sortQuests);

        enterEditModeButton.addEventListener('click', () => {
            if (passwordInput.value === correctPassword) {
                isEditMode = true;
                passwordInput.value = ''; // Passwortfeld leeren
                updateUIForMode();
                selectQuest(selectedQuestId); // Details im Edit-Modus neu laden
                showMessageBox('Bearbeitungsmodus aktiviert!');
            } else {
                showMessageBox('Falsches Passwort!');
                passwordInput.value = ''; // Passwortfeld leeren
            }
        });

        closeButton.addEventListener('click', () => {
            // Beim Schließen in den Ansichtsmodus zurückkehren
            isEditMode = false;
            passwordInput.value = ''; // Passwortfeld leeren
            updateUIForMode();
            showMessageBox('Das Questlog schließt sich und kehrt in den Ansichtsmodus zurück.');
            // Hier könntest du die Sichtbarkeit des Hauptfensters steuern, z.B.
            // document.querySelector('.questlog-window').style.display = 'none';
        });

        // App beim Laden starten
        document.addEventListener('DOMContentLoaded', initializeFirebaseAndLoadQuests);
    </script>
</body>
</html>
